# TODO 2025-12-11

## 1. Рефакторинг архитектуры парсинга чеков — ВЫПОЛНЕНО

**Проблема**: ~~Текущая архитектура игнорирует настройку `Parser` в `ReceiptSource`. Вместо этого `ReceiptTextParserFactory` перебирает все парсеры методом `CanParse()`.~~

**Правильная архитектура**:
```
ReceiptSource (настройки)
    │
    ├── Parser: "InstamartParser" / "LlmUniversalParser" / "Auto"
    │
    ↓
ReceiptParsingService.ParseReceiptAsync(body, date, parserName, ...)
    │
    ├── parserName = "Auto" → используем "LlmUniversalParser"
    │
    ├── GetParser(parserName) → IReceiptTextParser
    │       ├── "InstamartParser" → InstamartParser
    │       └── "LlmUniversalParser" → LlmUniversalParser
    │
    ├── parser.Parse(body, date)
    │       ├── Success → return result
    │       └── Error → Log ошибку + fallback на LlmUniversalParser (если ещё не он)
    │
    └── return result
```

**Изменения**:
- [x] `LlmUniversalParser : IReceiptTextParser` - новый класс с LLM логикой
- [x] `ReceiptTextParserFactory` - метод `GetParser(name)` и `GetParserOrDefault(name)`
- [x] `ReceiptCollectionService` - использует парсер по имени из `source.ParserName`, fallback на LLM
- [x] DI регистрация `LlmUniversalParser`
- [x] `IReceiptTextParser.CanParse()` - оставлен для UI и auto-detect
- [x] `IReceiptParsingService` - удалён (был в старом flow MainViewModel)

---

## 2. Batch-назначение меток (Labels) — ВЫПОЛНЕНО

**Проблема**: ~~Сейчас `LabelAssignmentService` вызывается для каждого товара отдельно.~~

**Решение**: ~~Использовать batch-режим для всего чека за 1 вызов LLM.~~

**Статус**: Уже реализовано! Batch-режим используется:
- [x] `ReceiptCollectionService.AssignLabelsAsync()` — вызывает `AssignLabelsBatchAsync`
- [x] `ReceiptProcessingService.AssignLabelsToNewItemsAsync()` — вызывает `AssignLabelsBatchAsync`
- [x] `LabelAssignmentService.AssignLabelsBatchAsync()` — метод реализован

---

## 3. Улучшение Application Log

**Проблемы**:
- Нельзя скопировать текст из лога
- Экран постоянно "трясется" (auto-scroll мешает)
- Неудобно читать при большом количестве сообщений

**Решение**:
- [ ] Сделать лог копируемым (TextBox вместо ListBox? или SelectionMode)
- [ ] Добавить кнопку "Pause auto-scroll" или остановка при ручной прокрутке
- [ ] Возможно: добавить кнопку "Copy all" для копирования всего лога
- [ ] Возможно: уровни логирования (DEBUG/INFO/WARN/ERROR) с фильтрацией

---

## 4. Метки не назначаются на Products и Items — ИСПРАВЛЕНО

**Проблема**: ~~После парсинга и классификации метки не сохраняются в БД.~~

**Причина**: Labels из `user_labels.txt` не синхронизировались в БД автоматически.

**Решение**:
- [x] `ILabelService.SyncFromFileAsync()` — загружает метки из файла в БД
- [x] `ReceiptCollectionService.AssignLabelsAsync()` — автоматически вызывает синхронизацию
- [x] `HtmlHelper` — утилита для очистки HTML (используется в парсерах)
- [x] `InstamartParser` — исправлен парсинг HTML писем

---

## 5. Подключение кастомного Yandex агента — ВЫПОЛНЕНО

**Задача**: Интеграция с кастомным Yandex-агентом (YandexGPT с кастомным промптом/агентом).

**Изменения**:
- [x] Изучить API кастомных агентов Yandex
- [x] Расширить `AiProviderType` enum → добавлен `YandexAgent`
- [x] Создан новый провайдер `YandexAgentLlmProvider`
- [x] Добавлено свойство `AgentId` в `AiProviderConfig`
- [x] Зарегистрирован в `AiProviderFactory`
- [x] UI настройки: поля Agent ID, Folder ID, API Key
- [x] REST Assistant API (`https://rest-assistant.api.cloud.yandex.net/v1/responses`)
- [x] Логирование запросов/ответов в формате ARCHITECTURE-AI.md
- [x] Тест подключения успешен

---

## 7. Анализ ответа AI моделей — ВЫПОЛНЕНО

**Задача**: Улучшить парсинг и обработку ответов от разных AI моделей.

**Проблема**:
- YandexAgent возвращает ответ в формате REST Assistant API (`output_text` или `output[]`)
- Разные модели могут возвращать JSON в разных форматах (markdown blocks, chain-of-thought)
- Нужна унифицированная логика извлечения JSON из ответа

**Изменения**:
- [x] Создан `IResponseParser` для унифицированного парсинга ответов
- [x] Поддержка markdown code blocks (```json...``` и ``` ... ```)
- [x] Поддержка chain-of-thought (извлечение JSON из reasoning с помощью bracket matching)
- [x] Fallback стратегии при ошибках парсинга:
  1. Markdown code block с тегом `json`
  2. Generic code block без тега
  3. Bracket matching (корректно обрабатывает вложенные структуры)
  4. Regex fallback
  5. Поиск после префиксов ("JSON:", "Результат:" и т.д.)
- [x] Логирование extraction method для отладки
- [x] Интегрировано в `ProductClassificationService`, `LabelAssignmentService`, `LlmUniversalParser`

---

## 8. Потоковое чтение ответов Yandex Agent

**Задача**: Добавить streaming для YandexAgentLlmProvider (если поддерживается API).

**Текущее состояние**:
- `OllamaLlmProvider` — streaming работает
- `YandexGptLlmProvider` — streaming работает
- `YandexAgentLlmProvider` — НЕТ streaming (один запрос-ответ)

**Изменения**:
- [ ] Изучить документацию REST Assistant API на предмет streaming
- [ ] Если streaming поддерживается — реализовать
- [ ] Если нет — добавить индикатор прогресса (waiting spinner)
- [ ] Унифицировать логирование streaming/non-streaming провайдеров

---

## 6. UI для настройки AI Prompts

**Задача**: Добавить возможность редактирования промптов через UI настроек.

**Текущее состояние**:
- Промпты хранятся в txt файлах рядом с exe
- Редактировать можно только вручную в текстовом редакторе

**Изменения**:
- [ ] Добавить секцию "AI Prompts" в Settings
- [ ] Список промптов с возможностью редактирования
- [ ] Кнопка "Reset to default" для каждого промпта
- [ ] Валидация плейсхолдеров (`{{LABELS}}`, `{{ITEMS}}`, etc.)
- [ ] Preview промпта с подстановкой тестовых данных

**Файлы промптов**:
- `prompt_template.txt` — парсинг чеков
- `prompt_classify_products.txt` — категоризация
- `prompt_assign_labels.txt` — назначение меток

---

## Выполнено сегодня

- [x] Убрана вкладка Settings из MainWindow (теперь отдельное окно)
- [x] Рефакторинг CLI на новую архитектуру (AiProviders, ReceiptSources)
- [x] Удалён мёртвый код: `ICategoryService`, `CategoryService`, `LlmProviderFactory`
- [x] Все сервисы переведены на `IAiProviderFactory`:
  - `ProductClassificationService`
  - `LabelAssignmentService`
  - `ReceiptParsingService`
- [x] Добавлено детальное логирование с проверкой на null-провайдер
- [x] Исправлены все warnings (0 warnings, 0 errors)
- [x] **Рефакторинг архитектуры парсинга (TODO #1)**:
  - Создан `LlmUniversalParser : IReceiptTextParser` — универсальный LLM парсер
  - `ReceiptTextParserFactory` — добавлены методы `GetParser(name)`, `GetParserOrDefault(name)`, `TryParseWithRegex()`
  - `ReceiptCollectionService` — теперь использует парсер из `source.ParserName` с fallback на LLM
  - Убрана зависимость `ReceiptCollectionService` от `IReceiptParsingService`
- [x] **Удаление legacy классов**:
  - Удалены `OllamaSettings.cs`, `YandexGptSettings.cs`, `EmailSettings.cs`, `LlmSettings.cs`
  - Удалён `ConfigurationMigrationService.cs` (миграция завершена)
  - Удалены `IOllamaService.cs`, `OllamaService.cs` (заменены на `ILlmProvider`)
  - `AppSettings` использует только новую архитектуру
- [x] **Рефакторинг namespace**:
  - Перемещены классы из `SmartBasket.Services.Ollama` в `SmartBasket.Services.Llm`
  - `ILabelAssignmentService`, `LabelAssignmentService`
  - `IProductClassificationService`, `ProductClassificationService`
  - `ParsedReceiptItem`, `ProductClassificationResult`
- [x] **Удалены #pragma warning disable CS0618**:
  - Заменён `TryParse()` на `TryParseWithRegex()` в `ReceiptParsingService`
  - Удалён obsolete метод `TryParse` из `ReceiptTextParserFactory`
- [x] **Исправлена проблема шифрования секретов**:
  - `SettingsService.Save()` теперь вызывает `DecryptSecrets()` после сохранения
  - API ключи и пароли остаются расшифрованными в памяти после сохранения
- [x] **Рефакторинг интерфейса IReceiptTextParser**:
  - `ShopName` → `Name` — уникальный идентификатор парсера для конфигурации
  - Добавлен `SupportedShops: IReadOnlyList<string>` — магазины для будущего авто-определения
  - `ReceiptTextParserFactory.GetParser()` теперь ищет по `Name`
  - Исправлена проблема: `Parser: "InstamartParser"` теперь находит парсер (раньше искал по ShopName="Instamart")
- [x] **Удалён legacy код из MainViewModel** (~450 строк):
  - Удалены legacy поля: `_emailService`, `_aiProviderFactory`, `_receiptParsingService`, etc.
  - Удалены legacy методы: `FetchAndParseEmailsAsync`, `TestEmailConnectionAsync`, `TestOllamaConnectionAsync`
  - Удалён legacy сервис: `ReceiptProcessingService.cs`
  - Кнопка Collect переключена на `CollectReceiptsCommand`
- [x] **InstamartParser: исправлен парсинг HTML писем**:
  - Добавлена очистка HTML перед парсингом (`HtmlHelper.CleanHtml()`)
  - Добавлен параметр `subject` в `IReceiptTextParser.Parse()`
  - Извлечение названия магазина из темы письма
- [x] **Автоматическая синхронизация Labels (TODO #4)**:
  - `ILabelService.SyncFromFileAsync()` — загружает метки из `user_labels.txt`
  - `ReceiptCollectionService` — автоматически синхронизирует метки перед назначением
- [x] **Yandex Agent Provider (TODO #5)**:
  - `YandexAgentLlmProvider` — новый провайдер для Yandex AI Studio агентов
  - `AiProviderType.YandexAgent` — новый тип провайдера
  - `AiProviderConfig.AgentId` — свойство для ID агента
  - `AiProviderFactory` — регистрация нового провайдера
- [x] **ResponseParser для унифицированного парсинга JSON (TODO #7)**:
  - `IResponseParser` / `ResponseParser` — унифицированный парсер ответов LLM
  - Поддержка markdown code blocks, chain-of-thought, bracket matching
  - 5 fallback стратегий для извлечения JSON
  - Интеграция в `ProductClassificationService`, `LabelAssignmentService`, `LlmUniversalParser`
