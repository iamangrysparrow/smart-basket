# TODO 2025-12-11

## 1. Рефакторинг архитектуры парсинга чеков

**Проблема**: Текущая архитектура игнорирует настройку `Parser` в `ReceiptSource`. Вместо этого `ReceiptTextParserFactory` перебирает все парсеры методом `CanParse()`.

**Правильная архитектура**:
```
ReceiptSource (настройки)
    │
    ├── Parser: "InstamartParser" / "LlmUniversalParser" / "Auto"
    │
    ↓
ReceiptParsingService.ParseReceiptAsync(body, date, parserName, ...)
    │
    ├── parserName = "Auto" → используем "LlmUniversalParser"
    │
    ├── GetParser(parserName) → IReceiptTextParser
    │       ├── "InstamartParser" → InstamartParser
    │       └── "LlmUniversalParser" → LlmUniversalParser
    │
    ├── parser.Parse(body, date)
    │       ├── Success → return result
    │       └── Error → Log ошибку + fallback на LlmUniversalParser (если ещё не он)
    │
    └── return result
```

**Изменения**:
- [x] `LlmUniversalParser : IReceiptTextParser` - новый класс с LLM логикой
- [x] `ReceiptTextParserFactory` - метод `GetParser(name)` и `GetParserOrDefault(name)`
- [x] `ReceiptCollectionService` - использует парсер по имени из `source.ParserName`, fallback на LLM
- [x] DI регистрация `LlmUniversalParser`
- [x] `IReceiptTextParser.CanParse()` - оставлен для UI и auto-detect
- [ ] `IReceiptParsingService` - legacy, может быть удалён (используется только в старом flow MainViewModel)

---

## 2. Batch-назначение меток (Labels) — ВЫПОЛНЕНО

**Проблема**: ~~Сейчас `LabelAssignmentService` вызывается для каждого товара отдельно.~~

**Решение**: ~~Использовать batch-режим для всего чека за 1 вызов LLM.~~

**Статус**: Уже реализовано! Batch-режим используется:
- [x] `ReceiptCollectionService.AssignLabelsAsync()` — вызывает `AssignLabelsBatchAsync`
- [x] `ReceiptProcessingService.AssignLabelsToNewItemsAsync()` — вызывает `AssignLabelsBatchAsync`
- [x] `LabelAssignmentService.AssignLabelsBatchAsync()` — метод реализован

---

## 3. Улучшение Application Log

**Проблемы**:
- Нельзя скопировать текст из лога
- Экран постоянно "трясется" (auto-scroll мешает)
- Неудобно читать при большом количестве сообщений

**Решение**:
- [ ] Сделать лог копируемым (TextBox вместо ListBox? или SelectionMode)
- [ ] Добавить кнопку "Pause auto-scroll" или остановка при ручной прокрутке
- [ ] Возможно: добавить кнопку "Copy all" для копирования всего лога
- [ ] Возможно: уровни логирования (DEBUG/INFO/WARN/ERROR) с фильтрацией

---

## 4. Метки не назначаются на Products и Items — ИСПРАВЛЕНО

**Проблема**: ~~После парсинга и классификации метки не сохраняются в БД.~~

**Причина**: Labels из `user_labels.txt` не синхронизировались в БД автоматически.

**Решение**:
- [x] `ILabelService.SyncFromFileAsync()` — загружает метки из файла в БД
- [x] `ReceiptCollectionService.AssignLabelsAsync()` — автоматически вызывает синхронизацию
- [x] `HtmlHelper` — утилита для очистки HTML (используется в парсерах)
- [x] `InstamartParser` — исправлен парсинг HTML писем

---

## 5. Подключение кастомного Yandex агента

**Задача**: Интеграция с кастомным Yandex-агентом (YandexGPT с кастомным промптом/агентом).

**Изменения**:
- [ ] Изучить API кастомных агентов Yandex
- [ ] Расширить `AiProviderType` enum (если нужен отдельный тип)
- [ ] Реализовать поддержку в `YandexGptLlmProvider` или создать новый провайдер
- [ ] Добавить настройки в `AiProviderConfig` (agent_id, etc.)
- [ ] Протестировать интеграцию

---

## 6. UI для настройки AI Prompts

**Задача**: Добавить возможность редактирования промптов через UI настроек.

**Текущее состояние**:
- Промпты хранятся в txt файлах рядом с exe
- Редактировать можно только вручную в текстовом редакторе

**Изменения**:
- [ ] Добавить секцию "AI Prompts" в Settings
- [ ] Список промптов с возможностью редактирования
- [ ] Кнопка "Reset to default" для каждого промпта
- [ ] Валидация плейсхолдеров (`{{LABELS}}`, `{{ITEMS}}`, etc.)
- [ ] Preview промпта с подстановкой тестовых данных

**Файлы промптов**:
- `prompt_template.txt` — парсинг чеков
- `prompt_classify_products.txt` — категоризация
- `prompt_assign_labels.txt` — назначение меток

---

## Выполнено сегодня

- [x] Убрана вкладка Settings из MainWindow (теперь отдельное окно)
- [x] Рефакторинг CLI на новую архитектуру (AiProviders, ReceiptSources)
- [x] Удалён мёртвый код: `ICategoryService`, `CategoryService`, `LlmProviderFactory`
- [x] Все сервисы переведены на `IAiProviderFactory`:
  - `ProductClassificationService`
  - `LabelAssignmentService`
  - `ReceiptParsingService`
- [x] Добавлено детальное логирование с проверкой на null-провайдер
- [x] Исправлены все warnings (0 warnings, 0 errors)
- [x] **Рефакторинг архитектуры парсинга (TODO #1)**:
  - Создан `LlmUniversalParser : IReceiptTextParser` — универсальный LLM парсер
  - `ReceiptTextParserFactory` — добавлены методы `GetParser(name)`, `GetParserOrDefault(name)`, `TryParseWithRegex()`
  - `ReceiptCollectionService` — теперь использует парсер из `source.ParserName` с fallback на LLM
  - Убрана зависимость `ReceiptCollectionService` от `IReceiptParsingService`
- [x] **Удаление legacy классов**:
  - Удалены `OllamaSettings.cs`, `YandexGptSettings.cs`, `EmailSettings.cs`, `LlmSettings.cs`
  - Удалён `ConfigurationMigrationService.cs` (миграция завершена)
  - Удалены `IOllamaService.cs`, `OllamaService.cs` (заменены на `ILlmProvider`)
  - `AppSettings` использует только новую архитектуру
- [x] **Рефакторинг namespace**:
  - Перемещены классы из `SmartBasket.Services.Ollama` в `SmartBasket.Services.Llm`
  - `ILabelAssignmentService`, `LabelAssignmentService`
  - `IProductClassificationService`, `ProductClassificationService`
  - `ParsedReceiptItem`, `ProductClassificationResult`
- [x] **Удалены #pragma warning disable CS0618**:
  - Заменён `TryParse()` на `TryParseWithRegex()` в `ReceiptParsingService`
  - Удалён obsolete метод `TryParse` из `ReceiptTextParserFactory`
- [x] **Исправлена проблема шифрования секретов**:
  - `SettingsService.Save()` теперь вызывает `DecryptSecrets()` после сохранения
  - API ключи и пароли остаются расшифрованными в памяти после сохранения
- [x] **Рефакторинг интерфейса IReceiptTextParser**:
  - `ShopName` → `Name` — уникальный идентификатор парсера для конфигурации
  - Добавлен `SupportedShops: IReadOnlyList<string>` — магазины для будущего авто-определения
  - `ReceiptTextParserFactory.GetParser()` теперь ищет по `Name`
  - Исправлена проблема: `Parser: "InstamartParser"` теперь находит парсер (раньше искал по ShopName="Instamart")
- [x] **Удалён legacy код из MainViewModel** (~450 строк):
  - Удалены legacy поля: `_emailService`, `_aiProviderFactory`, `_receiptParsingService`, etc.
  - Удалены legacy методы: `FetchAndParseEmailsAsync`, `TestEmailConnectionAsync`, `TestOllamaConnectionAsync`
  - Удалён legacy сервис: `ReceiptProcessingService.cs`
  - Кнопка Collect переключена на `CollectReceiptsCommand`
- [x] **InstamartParser: исправлен парсинг HTML писем**:
  - Добавлена очистка HTML перед парсингом (`HtmlHelper.CleanHtml()`)
  - Добавлен параметр `subject` в `IReceiptTextParser.Parse()`
  - Извлечение названия магазина из темы письма
- [x] **Автоматическая синхронизация Labels (TODO #4)**:
  - `ILabelService.SyncFromFileAsync()` — загружает метки из `user_labels.txt`
  - `ReceiptCollectionService` — автоматически синхронизирует метки перед назначением
