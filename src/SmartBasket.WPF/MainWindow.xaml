<Window x:Class="SmartBasket.WPF.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:views="clr-namespace:SmartBasket.WPF.Views"
        xmlns:models="clr-namespace:SmartBasket.WPF.Models"
        mc:Ignorable="d"
        Title="Smart Basket"
        Height="750" Width="1200"
        MinHeight="500" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}"
        Loaded="Window_Loaded">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar - new design system style -->
        <Border Grid.Row="0"
                Background="{DynamicResource BackgroundLayer1Brush}"
                BorderBrush="{DynamicResource BorderDefaultBrush}"
                BorderThickness="0,0,0,1"
                Height="{DynamicResource ToolbarHeight}">
            <DockPanel Margin="16,0">
                <!-- Logo (Left) -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center" Margin="0,0,24,0">
                    <Border Background="{DynamicResource AccentBrush}"
                            CornerRadius="6" Width="24" Height="24" Margin="0,0,8,0">
                        <TextBlock Text="ðŸ›’" FontSize="12" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <TextBlock Text="Smart Basket"
                               Style="{StaticResource SubtitleText}"
                               Foreground="{DynamicResource AccentBrush}"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Tabs (Left, after logo) -->
                <StackPanel x:Name="TabButtons" Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Stretch">
                    <RadioButton x:Name="TabReceipts"
                                 Style="{StaticResource TabButton}"
                                 Content="Ð§ÐµÐºÐ¸"
                                 IsChecked="True"
                                 Checked="TabReceipts_Checked"
                                 GroupName="MainTabs"/>
                    <RadioButton x:Name="TabProducts"
                                 Style="{StaticResource TabButton}"
                                 Content="ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹"
                                 Checked="TabProducts_Checked"
                                 GroupName="MainTabs"/>
                </StackPanel>

                <!-- Actions (Right) -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Right" VerticalAlignment="Center">
                    <!-- AI Chat Button -->
                    <Button Style="{StaticResource SecondaryButton}"
                            Click="OpenAiChat_Click"
                            ToolTip="AI ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚"
                            Padding="12,6"
                            Margin="0,0,8,0">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconAiChat}"
                                  Fill="{DynamicResource AccentBrush}"
                                  Width="14" Height="14" Stretch="Uniform"
                                  Margin="0,0,6,0"/>
                            <TextBlock Text="AI Chat"/>
                        </StackPanel>
                    </Button>

                    <!-- Collect Button (Primary) -->
                    <Button Style="{StaticResource PrimaryButton}"
                            Command="{Binding CollectReceiptsCommand}"
                            IsEnabled="{Binding IsNotProcessing}"
                            ToolTip="Collect receipts from all sources (Ctrl+F)"
                            Padding="12,6">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="âœ“" Margin="0,0,6,0"/>
                            <TextBlock Text="Collect"/>
                        </StackPanel>
                    </Button>

                    <!-- Cancel Button (visible only when processing) -->
                    <Button Style="{StaticResource DangerButton}"
                            Command="{Binding CancelOperationCommand}"
                            Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVis}}"
                            ToolTip="Cancel operation"
                            Margin="8,0,0,0"
                            Padding="12,6">
                        <TextBlock Text="Cancel"/>
                    </Button>

                    <!-- Divider -->
                    <Border Width="1" Height="24" Background="{DynamicResource BorderDefaultBrush}" Margin="12,0"/>

                    <!-- DB Actions (Ghost buttons) -->
                    <Button Style="{StaticResource ToolbarIconButton}"
                            Command="{Binding InitializeDatabaseCommand}"
                            IsEnabled="{Binding IsNotProcessing}"
                            ToolTip="Initialize database">
                        <Path Data="{StaticResource IconDatabase}"
                              Fill="{DynamicResource ForegroundSecondaryBrush}"
                              Width="16" Height="16" Stretch="Uniform"/>
                    </Button>

                    <Button Style="{StaticResource ToolbarIconButton}"
                            Command="{Binding ResetDatabaseCommand}"
                            IsEnabled="{Binding IsNotProcessing}"
                            ToolTip="Reset database (destructive!)">
                        <Path Data="{StaticResource IconTrash}"
                              Fill="{DynamicResource ErrorBrush}"
                              Width="16" Height="16" Stretch="Uniform"/>
                    </Button>

                    <!-- Divider -->
                    <Border Width="1" Height="24" Background="{DynamicResource BorderDefaultBrush}" Margin="8,0"/>

                    <!-- Logs Toggle -->
                    <Button Style="{StaticResource ToolbarIconButton}"
                            Click="ToggleLogPanel_Click"
                            ToolTip="Toggle log panel">
                        <Path Data="{StaticResource IconLog}"
                              Fill="{DynamicResource ForegroundSecondaryBrush}"
                              Width="16" Height="16" Stretch="Uniform"/>
                    </Button>

                    <!-- Settings -->
                    <Button Style="{StaticResource ToolbarIconButton}"
                            Click="OpenSettingsWindow_Click"
                            ToolTip="Settings">
                        <Path Data="{StaticResource IconSettings}"
                              Fill="{DynamicResource ForegroundSecondaryBrush}"
                              Width="16" Height="16" Stretch="Uniform"/>
                    </Button>

                    <!-- Theme Toggle -->
                    <Button x:Name="ThemeToggleButton"
                            Style="{StaticResource ToolbarIconButton}"
                            Click="ToggleTheme_Click"
                            ToolTip="Toggle light/dark theme">
                        <Path x:Name="ThemeIcon"
                              Data="{StaticResource IconMoon}"
                              Fill="{DynamicResource WarningBrush}"
                              Width="16" Height="16" Stretch="Uniform"/>
                    </Button>
                </StackPanel>

                <!-- Stats (Center, takes remaining space) -->
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,16,0">
                    <TextBlock Style="{StaticResource CaptionText}" VerticalAlignment="Center">
                        <Run Text="{Binding Receipts.Count, Mode=OneWay, FallbackValue=0}"
                             Foreground="{DynamicResource AccentBrush}"
                             FontWeight="SemiBold"/>
                        <Run Text=" Ñ‡ÐµÐºÐ¾Ð²"/>
                    </TextBlock>
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Content area - TabControl with hidden headers (controlled by toolbar RadioButtons) -->
        <TabControl x:Name="MainTabControl" Grid.Row="1"
                    Background="{DynamicResource BackgroundBaseBrush}"
                    BorderThickness="0"
                    SelectionChanged="MainTabControl_SelectionChanged">
            <!-- Hide tab headers - they are in toolbar now -->
            <TabControl.ItemContainerStyle>
                <Style TargetType="TabItem">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </Style>
            </TabControl.ItemContainerStyle>

            <!-- Tab 1: Ð§ÐµÐºÐ¸ -->
            <TabItem>
                <views:HistoryView x:Name="HistoryViewControl"/>
            </TabItem>

            <!-- Tab 2: ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ -->
            <TabItem>
                <views:ProductsItemsView x:Name="ProductsItemsViewControl"/>
            </TabItem>

            <!-- Tab 3: AI ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ (Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ÑÑ/ÑƒÐ´Ð°Ð»ÑÐµÑ‚ÑÑ) -->
        </TabControl>

        <!-- AI Chat Tab Header (Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ ÐºÐ¾Ð³Ð´Ð° Ð²ÐºÐ»Ð°Ð´ÐºÐ° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð°) -->
        <Border x:Name="AiChatTabHeader"
                Grid.Row="1"
                VerticalAlignment="Top"
                HorizontalAlignment="Right"
                Margin="0,8,16,0"
                Visibility="Collapsed"
                Background="{DynamicResource BackgroundLayer1Brush}"
                BorderBrush="{DynamicResource BorderDefaultBrush}"
                BorderThickness="1"
                CornerRadius="6"
                Padding="12,6">
            <StackPanel Orientation="Horizontal">
                <Path Data="{StaticResource IconAiChat}"
                      Fill="{DynamicResource AccentBrush}"
                      Width="14" Height="14" Stretch="Uniform"
                      Margin="0,0,6,0"/>
                <TextBlock Text="AI ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚"
                           Style="{StaticResource BodyText}"
                           Foreground="{DynamicResource ForegroundPrimaryBrush}"
                           VerticalAlignment="Center"/>
                <Button Style="{StaticResource ToolbarIconButton}"
                        Click="CloseAiChat_Click"
                        ToolTip="Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ"
                        Margin="8,0,0,0"
                        Padding="4">
                    <Path Data="{StaticResource IconClose}"
                          Fill="{DynamicResource ForegroundSecondaryBrush}"
                          Width="10" Height="10" Stretch="Uniform"/>
                </Button>
            </StackPanel>
        </Border>

        <!-- Log Panel -->
        <GridSplitter Grid.Row="2" Height="3" HorizontalAlignment="Stretch" Background="{DynamicResource BorderBrush}"
                      Cursor="SizeNS" Visibility="{Binding ElementName=LogPanel, Path=Visibility}"/>

        <Border Grid.Row="2" x:Name="LogPanel" Background="{DynamicResource LogBackgroundBrush}"
                Height="160" MinHeight="80" MaxHeight="400" Visibility="Collapsed"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <Border.Resources>
                <!-- Log level indicator style -->
                <Style x:Key="LogLevelIndicator" TargetType="Border">
                    <Setter Property="Width" Value="3"/>
                    <Setter Property="Margin" Value="0,1,6,1"/>
                    <Setter Property="CornerRadius" Value="1"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Debug}">
                            <Setter Property="Background" Value="{DynamicResource TextTertiaryBrush}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Info}">
                            <Setter Property="Background" Value="{DynamicResource InfoBrush}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Warning}">
                            <Setter Property="Background" Value="{DynamicResource WarningBrush}"/>
                        </DataTrigger>
                        <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Error}">
                            <Setter Property="Background" Value="{DynamicResource ErrorBrush}"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
                <!-- Filter toggle style -->
                <Style x:Key="MiniFilterToggle" TargetType="ToggleButton">
                    <Setter Property="Padding" Value="4,1"/>
                    <Setter Property="Margin" Value="1,0"/>
                    <Setter Property="FontSize" Value="9"/>
                    <Setter Property="FontWeight" Value="SemiBold"/>
                    <Setter Property="Cursor" Value="Hand"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="{DynamicResource TextSecondaryBrush}"/>
                    <Setter Property="BorderThickness" Value="1"/>
                    <Setter Property="BorderBrush" Value="{DynamicResource BorderLightBrush}"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ToggleButton">
                                <Border Background="{TemplateBinding Background}"
                                        BorderBrush="{TemplateBinding BorderBrush}"
                                        BorderThickness="{TemplateBinding BorderThickness}"
                                        CornerRadius="2" Padding="{TemplateBinding Padding}">
                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                </Border>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <Trigger Property="IsChecked" Value="True">
                            <Setter Property="Background" Value="{DynamicResource AccentLightBrush}"/>
                            <Setter Property="Foreground" Value="{DynamicResource AccentBrush}"/>
                            <Setter Property="BorderBrush" Value="{DynamicResource AccentBrush}"/>
                        </Trigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
            </Border.Resources>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="{DynamicResource LogHeaderBrush}" Padding="4,2">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <Path Data="{StaticResource IconLog}" Fill="{DynamicResource LogTextBrush}" Width="12" Height="12" Stretch="Uniform"/>
                            <TextBlock Text="Output" FontWeight="SemiBold" FontSize="10" Foreground="{DynamicResource LogTextBrush}" VerticalAlignment="Center" Margin="4,0,0,0"/>
                            <ProgressBar Width="50" Height="4" Margin="6,0,0,0" IsIndeterminate="{Binding IsProcessing}"
                                         Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVis}}" VerticalAlignment="Center"/>
                        </StackPanel>

                        <!-- Level filters -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Margin="12,0,0,0" VerticalAlignment="Center">
                            <ToggleButton Style="{StaticResource MiniFilterToggle}" Content="D" IsChecked="{Binding ShowDebug}" ToolTip="Debug"/>
                            <ToggleButton Style="{StaticResource MiniFilterToggle}" Content="I" IsChecked="{Binding ShowInfo}" ToolTip="Info"/>
                            <ToggleButton Style="{StaticResource MiniFilterToggle}" Content="W" IsChecked="{Binding ShowWarning}" ToolTip="Warning"/>
                            <ToggleButton Style="{StaticResource MiniFilterToggle}" Content="E" IsChecked="{Binding ShowError}" ToolTip="Error"/>
                        </StackPanel>

                        <TextBlock Grid.Column="2" Text="{Binding StatusText}" Foreground="{DynamicResource TextSecondaryBrush}"
                                   FontSize="10" VerticalAlignment="Center" Margin="8,0,0,0" TextTrimming="CharacterEllipsis"/>

                        <StackPanel Grid.Column="3" Orientation="Horizontal">
                            <Button Style="{StaticResource ToolbarButton}" Command="{Binding CopyLogCommand}" ToolTip="Copy">
                                <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                      Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                            <Button Style="{StaticResource ToolbarButton}" Command="{Binding ClearLogCommand}" ToolTip="Clear">
                                <Path Data="{StaticResource IconClear}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                            <Button Style="{StaticResource ToolbarButton}" Command="{Binding SaveLogCommand}" ToolTip="Save">
                                <Path Data="{StaticResource IconSave}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                            <Button Style="{StaticResource ToolbarButton}" Click="PopOutLog_Click" ToolTip="Pop out">
                                <Path Data="{StaticResource IconPopOut}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                            <Button Style="{StaticResource ToolbarButton}" Click="ToggleLogPanel_Click" ToolTip="Hide">
                                <Path Data="{StaticResource IconArrowDown}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>

                <ListBox Grid.Row="1" x:Name="LogListBox" ItemsSource="{Binding FilteredLogEntries}"
                         Background="{DynamicResource LogBackgroundBrush}" Foreground="{DynamicResource LogTextBrush}"
                         FontFamily="Cascadia Code, Consolas, Courier New" FontSize="10" BorderThickness="0"
                         SelectionMode="Extended"
                         ScrollViewer.HorizontalScrollBarVisibility="Auto"
                         ScrollViewer.CanContentScroll="True"
                         VirtualizingPanel.IsVirtualizing="True"
                         VirtualizingPanel.VirtualizationMode="Recycling"
                         ScrollViewer.ScrollChanged="LogListBox_ScrollChanged">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Height" Value="18"/>
                            <Setter Property="Padding" Value="4,0"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="VerticalContentAlignment" Value="Center"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource SelectedBrush}"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type models:LogEntry}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Border Grid.Column="0" Style="{StaticResource LogLevelIndicator}"/>
                                <TextBlock Grid.Column="1"
                                           Text="{Binding FormattedMessage, Mode=OneWay}"
                                           Foreground="{DynamicResource LogTextBrush}"
                                           FontFamily="Cascadia Code, Consolas, Courier New"
                                           FontSize="10"
                                           TextWrapping="NoWrap"/>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                    <ListBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Copy Selected" Command="{Binding CopyLogCommand}" InputGestureText="Ctrl+C">
                                <MenuItem.Icon>
                                    <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                          Fill="{DynamicResource TextPrimaryBrush}" Width="12" Height="12" Stretch="Uniform"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Clear All" Command="{Binding ClearLogCommand}">
                                <MenuItem.Icon>
                                    <Path Data="{StaticResource IconClear}"
                                          Fill="{DynamicResource TextPrimaryBrush}" Width="12" Height="12" Stretch="Uniform"/>
                                </MenuItem.Icon>
                            </MenuItem>
                        </ContextMenu>
                    </ListBox.ContextMenu>
                </ListBox>
            </Grid>
        </Border>

        <!-- Status Bar - new design system style -->
        <Border Grid.Row="3"
                Background="{DynamicResource BackgroundLayer1Brush}"
                BorderBrush="{DynamicResource BorderDefaultBrush}"
                BorderThickness="0,1,0,0"
                Height="{DynamicResource StatusBarHeight}">
            <DockPanel Margin="16,0">
                <!-- Left: Status indicator -->
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Left" VerticalAlignment="Center">
                    <Ellipse Width="8" Height="8"
                             Fill="{DynamicResource SuccessBrush}"
                             Margin="0,0,6,0"/>
                    <TextBlock Style="{StaticResource CaptionText}"
                               Text="{Binding StatusText}"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- Right: Stats (from ProductsItemsViewModel) -->
                <TextBlock Style="{StaticResource CaptionText}"
                           DockPanel.Dock="Right"
                           VerticalAlignment="Center">
                    <Run Text="ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ð¾Ð²: "/>
                    <Run Text="{Binding DataContext.TotalProductsCount, ElementName=ProductsItemsViewControl, Mode=OneWay, FallbackValue=0}"/>
                    <Run Text=" | Ð¢Ð¾Ð²Ð°Ñ€Ð¾Ð²: "/>
                    <Run Text="{Binding DataContext.TotalItemsCount, ElementName=ProductsItemsViewControl, Mode=OneWay, FallbackValue=0}"/>
                    <Run Text=" | Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾: "/>
                    <Run Text="{Binding DataContext.SelectedItemsCount, ElementName=ProductsItemsViewControl, Mode=OneWay, FallbackValue=0}"
                         Foreground="{DynamicResource AccentBrush}"/>
                </TextBlock>

                <!-- Center: Progress (when processing) -->
                <ProgressBar Width="100" Height="4"
                             IsIndeterminate="{Binding IsProcessing}"
                             Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVis}}"
                             HorizontalAlignment="Center"
                             VerticalAlignment="Center"
                             Margin="16,0"/>
            </DockPanel>
        </Border>
    </Grid>
</Window>
