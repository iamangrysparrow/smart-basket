<Window x:Class="SmartBasket.WPF.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:views="clr-namespace:SmartBasket.WPF.Views"
        mc:Ignorable="d"
        Title="Smart Basket"
        Height="750" Width="1200"
        MinHeight="500" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}"
        Loaded="Window_Loaded">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar - compact VS-style -->
        <Border Grid.Row="0"
                Background="{DynamicResource ToolbarBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="4,2">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <!-- Fetch - BLUE -->
                    <Button Style="{StaticResource ToolbarButton}"
                            Command="{Binding FetchAndParseEmailsCommand}"
                            IsEnabled="{Binding IsNotProcessing}"
                            ToolTip="Fetch emails (Ctrl+F)">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconEmail}"
                                  Fill="#0078D4" Width="14" Height="14" Stretch="Uniform"/>
                            <TextBlock Text="Fetch" Margin="4,0,0,0" Foreground="#0078D4" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Button>

                    <!-- Cancel - RED -->
                    <Button Style="{StaticResource ToolbarButton}"
                            Command="{Binding CancelOperationCommand}"
                            IsEnabled="{Binding IsProcessing}"
                            ToolTip="Cancel">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconCancel}"
                                  Fill="#D13438" Width="12" Height="12" Stretch="Uniform"/>
                            <TextBlock Text="Cancel" Margin="4,0,0,0" Foreground="#D13438"/>
                        </StackPanel>
                    </Button>

                    <Separator Style="{StaticResource ToolbarSeparator}"/>

                    <!-- Refresh - GREEN -->
                    <Button Style="{StaticResource ToolbarButton}"
                            Command="{Binding LoadReceiptsCommand}"
                            IsEnabled="{Binding IsNotProcessing}"
                            ToolTip="Refresh (F5)">
                        <Path Data="{StaticResource IconRefresh}"
                              Fill="#107C10" Width="14" Height="14" Stretch="Uniform"/>
                    </Button>

                    <!-- Init DB - ORANGE -->
                    <Button Style="{StaticResource ToolbarButton}"
                            Command="{Binding InitializeDatabaseCommand}"
                            IsEnabled="{Binding IsNotProcessing}"
                            ToolTip="Initialize database">
                        <Path Data="{StaticResource IconDatabase}"
                              Fill="#CA5010" Width="14" Height="14" Stretch="Uniform"/>
                    </Button>

                    <!-- Reset DB - RED -->
                    <Button Style="{StaticResource ToolbarButton}"
                            Command="{Binding ResetDatabaseCommand}"
                            IsEnabled="{Binding IsNotProcessing}"
                            ToolTip="Reset database (destructive!)">
                        <Path Data="{StaticResource IconTrash}"
                              Fill="#D13438" Width="14" Height="14" Stretch="Uniform"/>
                    </Button>

                    <Separator Style="{StaticResource ToolbarSeparator}"/>

                    <!-- Logs - PURPLE -->
                    <Button Style="{StaticResource ToolbarButton}"
                            Click="ToggleLogPanel_Click"
                            ToolTip="Toggle log panel">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconLog}"
                                  Fill="#881798" Width="14" Height="14" Stretch="Uniform"/>
                            <TextBlock Text="Logs" Margin="4,0,0,0" Foreground="#881798"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <!-- Theme Toggle - YELLOW -->
                <Button Grid.Column="1" x:Name="ThemeToggleButton"
                        Style="{StaticResource ToolbarButton}"
                        Click="ToggleTheme_Click"
                        ToolTip="Toggle light/dark theme">
                    <Path x:Name="ThemeIcon"
                          Data="{StaticResource IconMoon}"
                          Fill="#FFB900" Width="14" Height="14" Stretch="Uniform"/>
                </Button>
            </Grid>
        </Border>

        <!-- Tabs with UserControls -->
        <TabControl Grid.Row="1" Style="{StaticResource ModernTabControl}">
            <TabControl.Resources>
                <Style TargetType="TabItem" BasedOn="{StaticResource ModernTabItem}"/>
            </TabControl.Resources>

            <!-- Tab 1: History -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconReceipt}" Fill="#0078D4" Width="12" Height="12" Stretch="Uniform" Margin="0,0,4,0"/>
                        <TextBlock Text="History"/>
                    </StackPanel>
                </TabItem.Header>
                <views:HistoryView/>
            </TabItem>

            <!-- Tab 2: Products & Items -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconProducts}" Fill="#CA5010" Width="12" Height="12" Stretch="Uniform" Margin="0,0,4,0"/>
                        <TextBlock Text="Products"/>
                    </StackPanel>
                </TabItem.Header>
                <views:ProductsItemsView x:Name="ProductsItemsViewControl"/>
            </TabItem>

            <!-- Tab 3: Settings -->
            <TabItem>
                <TabItem.Header>
                    <StackPanel Orientation="Horizontal">
                        <Path Data="{StaticResource IconSettings}" Fill="#881798" Width="12" Height="12" Stretch="Uniform" Margin="0,0,4,0"/>
                        <TextBlock Text="Settings"/>
                    </StackPanel>
                </TabItem.Header>
                <views:SettingsView x:Name="SettingsViewControl"/>
            </TabItem>
        </TabControl>

        <!-- Log Panel -->
        <GridSplitter Grid.Row="2" Height="3" HorizontalAlignment="Stretch" Background="{DynamicResource BorderBrush}"
                      Cursor="SizeNS" Visibility="{Binding ElementName=LogPanel, Path=Visibility}"/>

        <Border Grid.Row="2" x:Name="LogPanel" Background="{DynamicResource LogBackgroundBrush}"
                Height="140" MinHeight="60" MaxHeight="350" Visibility="Collapsed"
                BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Background="{DynamicResource LogHeaderBrush}" Padding="4,2">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <Path Data="{StaticResource IconLog}" Fill="{DynamicResource LogTextBrush}" Width="12" Height="12" Stretch="Uniform"/>
                            <TextBlock Text="Output" FontWeight="SemiBold" FontSize="10" Foreground="{DynamicResource LogTextBrush}" VerticalAlignment="Center" Margin="4,0,0,0"/>
                            <ProgressBar Width="50" Height="4" Margin="6,0,0,0" IsIndeterminate="{Binding IsProcessing}"
                                         Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVis}}" VerticalAlignment="Center"/>
                        </StackPanel>

                        <TextBlock Grid.Column="1" Text="{Binding StatusText}" Foreground="{DynamicResource TextSecondaryBrush}"
                                   FontSize="10" VerticalAlignment="Center" Margin="8,0,0,0" TextTrimming="CharacterEllipsis"/>

                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                            <Button Style="{StaticResource ToolbarButton}" Command="{Binding ClearLogCommand}" ToolTip="Clear">
                                <Path Data="{StaticResource IconClear}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                            <Button Style="{StaticResource ToolbarButton}" Command="{Binding SaveLogCommand}" ToolTip="Save">
                                <Path Data="{StaticResource IconSave}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                            <Button Style="{StaticResource ToolbarButton}" Click="PopOutLog_Click" ToolTip="Pop out">
                                <Path Data="{StaticResource IconPopOut}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                            <Button Style="{StaticResource ToolbarButton}" Click="ToggleLogPanel_Click" ToolTip="Hide">
                                <Path Data="{StaticResource IconArrowDown}" Fill="{DynamicResource LogTextBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>

                <ListBox Grid.Row="1" x:Name="LogListBox" ItemsSource="{Binding LogEntries}"
                         Background="{DynamicResource LogBackgroundBrush}" Foreground="{DynamicResource LogTextBrush}"
                         FontFamily="Cascadia Code, Consolas, Courier New" FontSize="10" BorderThickness="0"
                         ScrollViewer.HorizontalScrollBarVisibility="Auto" VirtualizingPanel.IsVirtualizing="True">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="6,1"/>
                            <Setter Property="BorderThickness" Value="0"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource LogHeaderBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListBox.ItemContainerStyle>
                </ListBox>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="{DynamicResource ToolbarBrush}" BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0" Padding="6,2">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="{Binding StatusText}" Style="{StaticResource TextSecondary}" FontSize="10" VerticalAlignment="Center"/>
                <ProgressBar Grid.Column="1" Width="80" Height="6" IsIndeterminate="{Binding IsProcessing}"
                             Visibility="{Binding IsProcessing, Converter={StaticResource BoolToVis}}"/>
            </Grid>
        </Border>
    </Grid>
</Window>
