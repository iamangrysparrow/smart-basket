<UserControl x:Class="SmartBasket.WPF.Views.Settings.AiProvidersSettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:SmartBasket.WPF.ViewModels.Settings"
             xmlns:core="clr-namespace:SmartBasket.Core.Configuration;assembly=SmartBasket.Core"
             xmlns:controls="clr-namespace:SmartBasket.WPF.Controls"
             mc:Ignorable="d"
             d:DesignHeight="500" d:DesignWidth="600">

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="AI Провайдеры" Style="{StaticResource H1}"/>
            <TextBlock Text="Конфигурации подключения к AI сервисам (Ollama, YandexGPT, OpenAI)"
                       Style="{StaticResource TextSecondary}" Margin="0,4,0,0"/>

            <!-- Ollama Status -->
            <Border Margin="0,8,0,0" Padding="8,6" CornerRadius="4">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="#1A4CAF50"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsOllamaAvailable}" Value="False">
                                <Setter Property="Background" Value="#1AF44336"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="8" Height="8" Margin="0,0,8,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="{DynamicResource SuccessBrush}"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsOllamaAvailable}" Value="False">
                                        <Setter Property="Fill" Value="{DynamicResource ErrorBrush}"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock Text="{Binding OllamaStatusMessage}" FontSize="11" VerticalAlignment="Center"/>
                    <TextBlock Margin="12,0,0,0" FontSize="11" VerticalAlignment="Center"
                               Visibility="{Binding IsOllamaAvailable, Converter={StaticResource InverseBoolToVis}}">
                        <Hyperlink NavigateUri="https://ollama.ai" RequestNavigate="Hyperlink_RequestNavigate"
                                   Foreground="{DynamicResource PrimaryBrush}">
                            Скачать Ollama
                        </Hyperlink>
                    </TextBlock>
                </StackPanel>
            </Border>
        </StackPanel>

        <!-- Provider List -->
        <Border Grid.Row="1" Style="{StaticResource Card}" Margin="0,0,0,12">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Список провайдеров" Style="{StaticResource H3}" Margin="0,0,0,8"/>

                <ListBox Grid.Row="1"
                         ItemsSource="{Binding AiProviders}"
                         SelectedItem="{Binding SelectedAiProvider}"
                         Height="100"
                         Background="Transparent"
                         BorderThickness="1"
                         BorderBrush="{DynamicResource BorderBrush}"
                         ScrollViewer.IsDeferredScrollingEnabled="False"
                         VirtualizingPanel.ScrollUnit="Pixel">
                    <ListBox.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:AiProviderViewModel}">
                            <StackPanel Orientation="Horizontal" Margin="4,2">
                                <TextBlock Text="{Binding Key}" VerticalAlignment="Center" FontWeight="SemiBold"/>
                                <TextBlock Text=" (" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                                <TextBlock Text="{Binding Provider}" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                                <TextBlock Text=")" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!-- Provider Editor -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto"
                      Visibility="{Binding HasSelectedAiProvider, Converter={StaticResource BoolToVis}}">
            <Border Style="{StaticResource Card}">
                <StackPanel DataContext="{Binding SelectedAiProvider}">
                    <TextBlock Text="Настройки провайдера" Style="{StaticResource H3}" Margin="0,0,0,8"/>

                    <!-- Basic Settings -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Ключ" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding Key, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource TextInput}" Margin="0,0,0,6"
                                 ToolTip="Формат: Provider/Model, например Ollama/llama3.2:3b"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Провайдер" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <ComboBox Grid.Row="1" Grid.Column="1" SelectedValue="{Binding Provider}"
                                  SelectedValuePath="Tag" FontSize="12" Padding="4,3" Margin="0,0,0,6">
                            <ComboBoxItem Content="Ollama (локальный)" Tag="{x:Static core:AiProviderType.Ollama}"/>
                            <ComboBoxItem Content="YandexGPT" Tag="{x:Static core:AiProviderType.YandexGPT}"/>
                            <ComboBoxItem Content="OpenAI / OpenAI-compatible" Tag="{x:Static core:AiProviderType.OpenAI}"/>
                        </ComboBox>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Модель" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <!-- Ollama models - динамический список -->
                        <ComboBox Grid.Row="2" Grid.Column="1" Text="{Binding Model, UpdateSourceTrigger=PropertyChanged}"
                                  IsEditable="True" FontSize="12" Padding="4,3" Margin="0,0,0,6"
                                  Visibility="{Binding IsOllama, Converter={StaticResource BoolToVis}}"
                                  ItemsSource="{Binding DataContext.OllamaModels, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                        <!-- YandexGPT models -->
                        <ComboBox Grid.Row="2" Grid.Column="1" Text="{Binding Model, UpdateSourceTrigger=PropertyChanged}"
                                  IsEditable="True" FontSize="12" Padding="4,3" Margin="0,0,0,6"
                                  Visibility="{Binding IsYandexGpt, Converter={StaticResource BoolToVis}}">
                            <ComboBoxItem Content="yandexgpt-lite"/>
                            <ComboBoxItem Content="yandexgpt"/>
                            <ComboBoxItem Content="yandexgpt-32k"/>
                        </ComboBox>
                        <!-- OpenAI models -->
                        <ComboBox Grid.Row="2" Grid.Column="1" Text="{Binding Model, UpdateSourceTrigger=PropertyChanged}"
                                  IsEditable="True" FontSize="12" Padding="4,3" Margin="0,0,0,6"
                                  Visibility="{Binding IsOpenAi, Converter={StaticResource BoolToVis}}">
                            <ComboBoxItem Content="gpt-4o-mini"/>
                            <ComboBoxItem Content="gpt-4o"/>
                            <ComboBoxItem Content="gpt-4-turbo"/>
                            <ComboBoxItem Content="gpt-3.5-turbo"/>
                        </ComboBox>
                    </Grid>

                    <!-- Connection Settings -->
                    <TextBlock Text="Подключение" Style="{StaticResource H3}" Margin="0,12,0,8"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- BaseUrl (Ollama, OpenAI) -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Base URL" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"
                                   Visibility="{Binding ShowBaseUrl, Converter={StaticResource BoolToVis}}"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding BaseUrl, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource TextInput}" Margin="0,0,0,6"
                                 Visibility="{Binding ShowBaseUrl, Converter={StaticResource BoolToVis}}"/>

                        <!-- API Key (YandexGPT, OpenAI) -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="API Key" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"
                                   Visibility="{Binding ShowApiKey, Converter={StaticResource BoolToVis}}"/>
                        <controls:PasswordBoxWithReveal Grid.Row="1" Grid.Column="1"
                                                        Password="{Binding ApiKey, UpdateSourceTrigger=PropertyChanged}"
                                                        Margin="0,0,0,6"
                                                        Visibility="{Binding ShowApiKey, Converter={StaticResource BoolToVis}}"/>

                        <!-- Folder ID (YandexGPT) -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Folder ID" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"
                                   Visibility="{Binding ShowFolderId, Converter={StaticResource BoolToVis}}"/>
                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding FolderId, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource TextInput}" Margin="0,0,0,6"
                                 Visibility="{Binding ShowFolderId, Converter={StaticResource BoolToVis}}"/>
                    </Grid>

                    <!-- Advanced Settings -->
                    <TextBlock Text="Дополнительно" Style="{StaticResource H3}" Margin="0,12,0,8"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="40"/>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Temperature" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1"
                                 Text="{Binding Temperature, UpdateSourceTrigger=LostFocus, Converter={StaticResource DoubleToString}}"
                                 Style="{StaticResource TextInput}" Width="60" Margin="0,0,0,6"/>

                        <TextBlock Grid.Row="0" Grid.Column="3" Text="Timeout (сек)" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="4" Text="{Binding TimeoutSeconds, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource TextInput}" Width="60" Margin="0,0,0,6"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Max Tokens" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding MaxTokens, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}"
                                 Style="{StaticResource TextInput}" Width="60"/>
                    </Grid>

                    <!-- Action Buttons -->
                    <StackPanel Orientation="Horizontal" Margin="0,16,0,0">
                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding DataContext.TestAiProviderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconPlug}" Fill="{DynamicResource TextPrimaryBrush}" Width="10" Height="10" Stretch="Uniform"/>
                                <TextBlock Text="Тест" Margin="4,0,0,0"/>
                            </StackPanel>
                        </Button>
                        <Button Style="{StaticResource DangerButton}"
                                Command="{Binding DataContext.DeleteAiProviderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}">
                            <StackPanel Orientation="Horizontal">
                                <Path Data="{StaticResource IconTrash}" Fill="{DynamicResource ErrorBrush}" Width="10" Height="10" Stretch="Uniform"/>
                                <TextBlock Text="Удалить" Margin="4,0,0,0"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- Empty State -->
        <TextBlock Grid.Row="2"
                   Text="Выберите провайдер из списка или добавьте новый"
                   Style="{StaticResource TextSecondary}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   Visibility="{Binding HasSelectedAiProvider, Converter={StaticResource InverseBoolToVis}}"/>
    </Grid>
</UserControl>
