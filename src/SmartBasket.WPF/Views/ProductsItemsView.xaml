<UserControl x:Class="SmartBasket.WPF.Views.ProductsItemsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:vm="clr-namespace:SmartBasket.WPF.ViewModels"
             xmlns:conv="clr-namespace:SmartBasket.WPF.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000"
             Background="{DynamicResource BackgroundBaseBrush}"
             Loaded="UserControl_Loaded">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Sub Toolbar (filters row) -->
        <Border Grid.Row="0" Style="{StaticResource SubToolbar}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Mode Switcher (Products/Labels) -->
                <Border Grid.Column="0" Style="{StaticResource ViewTabsContainer}">
                    <StackPanel Orientation="Horizontal">
                        <RadioButton x:Name="ProductsModeBtn" Content="Продукты"
                                     IsChecked="{Binding IsProductsMode, Mode=TwoWay}"
                                     Style="{StaticResource ViewTabButton}"/>
                        <RadioButton Content="Метки"
                                     IsChecked="{Binding IsLabelsMode, Mode=OneWay}"
                                     Style="{StaticResource ViewTabButton}"/>
                    </StackPanel>
                </Border>

                <Border Grid.Column="1" Style="{StaticResource ToolbarDivider}"/>

                <!-- Filters -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Магазин:" Style="{StaticResource FilterLabel}"/>
                    <ComboBox Width="120"
                              ItemsSource="{Binding ShopFilters}"
                              SelectedItem="{Binding SelectedShopFilter}"
                              Style="{StaticResource FilterComboBox}"/>

                    <CheckBox Content="С дочерними" Style="{StaticResource FilterCheckBox}"
                              IsChecked="{Binding IncludeChildrenItems}"
                              Visibility="{Binding ShowIncludeChildren, Converter={StaticResource BoolToVis}}"/>

                    <!-- Labels emptiness filter (only in labels mode) -->
                    <TextBlock Text="Показать:" Style="{StaticResource FilterLabel}"
                               Margin="16,0,6,0"
                               Visibility="{Binding IsLabelsMode, Converter={StaticResource BoolToVis}}"/>
                    <ComboBox Width="100"
                              ItemsSource="{Binding LabelEmptinessFilters}"
                              SelectedItem="{Binding SelectedLabelEmptinessFilter}"
                              Style="{StaticResource FilterComboBox}"
                              Visibility="{Binding IsLabelsMode, Converter={StaticResource BoolToVis}}"/>
                </StackPanel>

                <!-- Spacer -->
                <Border Grid.Column="3"/>

                <!-- Statistics Badge -->
                <Border Grid.Column="4" Style="{StaticResource StatsBadge}">
                    <TextBlock Style="{StaticResource StatsBadgeText}">
                        <Run Text="Продуктов: "/>
                        <Run Text="{Binding TotalProductsCount}"/>
                        <Run Text=" | Товаров: "/>
                        <Run Text="{Binding TotalItemsCount}"/>
                    </TextBlock>
                </Border>
            </Grid>
        </Border>

        <!-- Main Content: Master-Detail Layout -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" MinWidth="200"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Master Panel (Left - Tree/List) -->
            <Border Grid.Column="0" Background="{DynamicResource BackgroundLayer1Brush}"
                    BorderBrush="{DynamicResource BorderDefaultBrush}"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Panel Header with action buttons -->
                    <Border Grid.Row="0" Style="{StaticResource PanelHeader}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" Style="{StaticResource PanelHeaderText}">
                                <TextBlock.Text>
                                    <Binding Path="IsLabelsMode">
                                        <Binding.Converter>
                                            <conv:BoolToStringConverter TrueValue="МЕТКИ" FalseValue="ПРОДУКТЫ"/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Text>
                            </TextBlock>

                            <!-- Action buttons (only in Products mode) -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal"
                                        Visibility="{Binding IsProductsMode, Converter={StaticResource BoolToVis}}">
                                <Button x:Name="AddProductBtn" Style="{StaticResource GhostButton}"
                                        Click="AddProductInline_Click" ToolTip="Добавить продукт"
                                        Padding="4" Margin="0,0,2,0">
                                    <Path Data="{StaticResource IconAdd}" Fill="{DynamicResource AccentBrush}"
                                          Width="12" Height="12" Stretch="Uniform"/>
                                </Button>
                                <Button x:Name="AddChildProductBtn" Style="{StaticResource GhostButton}"
                                        Click="AddChildProductInline_Click" ToolTip="Добавить подуровень"
                                        Padding="4" Margin="0,0,2,0"
                                        IsEnabled="{Binding CanAddChildProduct}">
                                    <Path Data="{StaticResource IconAddChild}" Fill="{DynamicResource SuccessBrush}"
                                          Width="12" Height="12" Stretch="Uniform"/>
                                </Button>
                                <Button x:Name="DeleteProductBtn" Style="{StaticResource GhostButton}"
                                        Click="DeleteProductInline_Click" ToolTip="Удалить"
                                        Padding="4" Margin="0,0,2,0"
                                        IsEnabled="{Binding CanDeleteProduct}">
                                    <Path Data="{StaticResource IconTrash}" Fill="{DynamicResource ErrorBrush}"
                                          Width="12" Height="12" Stretch="Uniform"/>
                                </Button>
                                <Button Style="{StaticResource GhostButton}" Command="{Binding RefreshCommand}"
                                        IsEnabled="{Binding IsNotBusy}" ToolTip="Обновить"
                                        Padding="4">
                                    <Path Data="{StaticResource IconRefresh}" Fill="{DynamicResource ForegroundSecondaryBrush}"
                                          Width="12" Height="12" Stretch="Uniform"/>
                                </Button>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Search Box -->
                    <Grid Grid.Row="1" Margin="12,12,12,8">
                        <Border Background="{DynamicResource BackgroundBaseBrush}"
                                BorderBrush="{DynamicResource BorderDefaultBrush}"
                                BorderThickness="1" CornerRadius="4">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <Path Grid.Column="0" Data="{StaticResource IconSearch}"
                                      Fill="{DynamicResource ForegroundTertiaryBrush}"
                                      Width="12" Height="12" Stretch="Uniform"
                                      Margin="10,0,8,0" VerticalAlignment="Center"/>

                                <TextBox x:Name="MasterSearchBox" Grid.Column="1"
                                         Text="{Binding MasterSearchText, UpdateSourceTrigger=PropertyChanged}"
                                         Background="Transparent" BorderThickness="0"
                                         Foreground="{DynamicResource ForegroundPrimaryBrush}"
                                         FontSize="12" Padding="0,6"
                                         VerticalContentAlignment="Center"/>

                                <TextBlock Grid.Column="1" Text="Поиск..." IsHitTestVisible="False"
                                           Foreground="{DynamicResource ForegroundTertiaryBrush}"
                                           FontSize="12" VerticalAlignment="Center" Margin="0,0,0,0"
                                           Visibility="{Binding Text.Length, ElementName=MasterSearchBox, Converter={StaticResource InverseBoolToVis}}"/>

                                <Button Grid.Column="2" Click="ClearSearchButton_Click"
                                        Visibility="{Binding Text.Length, ElementName=MasterSearchBox, Converter={StaticResource IntToVis}}"
                                        Background="Transparent" BorderThickness="0"
                                        Padding="8,6" Cursor="Hand">
                                    <Path Data="{StaticResource IconCancel}"
                                          Fill="{DynamicResource ForegroundSecondaryBrush}"
                                          Width="10" Height="10" Stretch="Uniform"/>
                                </Button>
                            </Grid>
                        </Border>
                    </Grid>

                    <!-- TreeView for Products -->
                    <TreeView Grid.Row="2" x:Name="ProductTreeView"
                              ItemsSource="{Binding ProductTree}"
                              SelectedItemChanged="ProductTree_SelectedItemChanged"
                              Style="{StaticResource ProductsTreeView}"
                              Padding="8,0"
                              Visibility="{Binding IsProductsMode, Converter={StaticResource BoolToVis}}">
                        <TreeView.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Добавить продукт" Click="AddProductInline_Click">
                                    <MenuItem.Icon>
                                        <Path Data="{StaticResource IconAdd}" Fill="{DynamicResource AccentBrush}"
                                              Width="12" Height="12" Stretch="Uniform"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Добавить подуровень" Click="AddChildProductInline_Click"
                                          IsEnabled="{Binding CanAddChildProduct}">
                                    <MenuItem.Icon>
                                        <Path Data="{StaticResource IconAddChild}" Fill="{DynamicResource SuccessBrush}"
                                              Width="12" Height="12" Stretch="Uniform"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <Separator/>
                                <MenuItem Header="Переименовать" Click="RenameProduct_Click" InputGestureText="F2"
                                          IsEnabled="{Binding CanEditProduct}">
                                    <MenuItem.Icon>
                                        <Path Data="{StaticResource IconEdit}" Fill="{DynamicResource ForegroundSecondaryBrush}"
                                              Width="12" Height="12" Stretch="Uniform"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                                <MenuItem Header="Удалить" Click="DeleteProductContext_Click"
                                          IsEnabled="{Binding CanDeleteProduct}">
                                    <MenuItem.Icon>
                                        <Path Data="{StaticResource IconTrash}" Fill="{DynamicResource ErrorBrush}"
                                              Width="12" Height="12" Stretch="Uniform"/>
                                    </MenuItem.Icon>
                                </MenuItem>
                            </ContextMenu>
                        </TreeView.ContextMenu>
                        <TreeView.ItemTemplate>
                            <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                <Grid>
                                    <!-- Normal view -->
                                    <StackPanel Orientation="Horizontal"
                                                Visibility="{Binding IsEditing, Converter={StaticResource InverseBoolToVis}}"
                                                MouseLeftButtonDown="ProductItem_MouseLeftButtonDown">
                                        <!-- Color dot for leaf items (no children) -->
                                        <Ellipse Style="{StaticResource TreeItemIcon}"
                                                 Fill="{DynamicResource AccentMutedBrush}"
                                                 Visibility="{Binding HasChildren, Converter={StaticResource InverseBoolToVis}}"/>
                                        <TextBlock conv:TextBlockHighlight.Text="{Binding Name}"
                                                   conv:TextBlockHighlight.HighlightText="{Binding SearchText}"
                                                   conv:TextBlockHighlight.HighlightBrush="{DynamicResource WarningSubtleBrush}"
                                                   FontSize="13"
                                                   Foreground="{DynamicResource ForegroundPrimaryBrush}"
                                                   VerticalAlignment="Center">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding HasChildren}" Value="True">
                                                            <Setter Property="FontWeight" Value="Medium"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                        <TextBlock Text="{Binding ItemCount, StringFormat=' ({0})'}"
                                                   Style="{StaticResource TreeItemCount}"/>
                                    </StackPanel>
                                    <!-- Edit view -->
                                    <StackPanel Orientation="Horizontal"
                                                Visibility="{Binding IsEditing, Converter={StaticResource BoolToVis}}">
                                        <TextBox Text="{Binding EditName, UpdateSourceTrigger=PropertyChanged}"
                                                 FontSize="13" MinWidth="120" Padding="4,2"
                                                 x:Name="EditTextBox"
                                                 KeyDown="EditTextBox_KeyDown"
                                                 LostFocus="EditTextBox_LostFocus"
                                                 Loaded="EditTextBox_Loaded"/>
                                    </StackPanel>
                                </Grid>
                            </HierarchicalDataTemplate>
                        </TreeView.ItemTemplate>
                        <TreeView.ItemContainerStyle>
                            <Style TargetType="TreeViewItem" BasedOn="{StaticResource ProductsTreeViewItem}">
                                <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                                <Setter Property="Visibility" Value="{Binding IsVisible, Converter={StaticResource BoolToVis}}"/>
                            </Style>
                        </TreeView.ItemContainerStyle>
                    </TreeView>

                    <!-- ListView for Labels -->
                    <ListBox Grid.Row="2" x:Name="LabelsListBox"
                             ItemsSource="{Binding Labels}"
                             SelectedItem="{Binding SelectedLabel}"
                             Style="{StaticResource SidebarListBox}"
                             Padding="8,0"
                             Visibility="{Binding IsLabelsMode, Converter={StaticResource BoolToVis}}">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem" BasedOn="{StaticResource SidebarListBoxItem}"/>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <Ellipse Width="10" Height="10" Margin="0,0,10,0" VerticalAlignment="Center">
                                        <Ellipse.Fill>
                                            <SolidColorBrush Color="{Binding Color}"/>
                                        </Ellipse.Fill>
                                    </Ellipse>
                                    <TextBlock Text="{Binding Name}" Style="{StaticResource TreeItemText}"/>
                                    <TextBlock Text="{Binding ItemCount, StringFormat=' ({0})'}"
                                               Style="{StaticResource TreeItemCount}"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- GridSplitter -->
            <GridSplitter Grid.Column="1" Width="1" HorizontalAlignment="Center"
                          Background="{DynamicResource BorderDefaultBrush}" Cursor="SizeWE"/>

            <!-- Detail Panel (Right - Items DataGrid) -->
            <Grid Grid.Column="2" Background="{DynamicResource BackgroundBaseBrush}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Search for Items -->
                <Grid Grid.Row="0" Margin="24,16,24,12">
                    <Border Background="{DynamicResource BackgroundBaseBrush}"
                            BorderBrush="{DynamicResource BorderDefaultBrush}"
                            BorderThickness="1" CornerRadius="4">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <Path Grid.Column="0" Data="{StaticResource IconSearch}"
                                  Fill="{DynamicResource ForegroundTertiaryBrush}"
                                  Width="12" Height="12" Stretch="Uniform"
                                  Margin="12,0,8,0" VerticalAlignment="Center"/>

                            <TextBox x:Name="ItemSearchBox" Grid.Column="1"
                                     Text="{Binding ItemSearchText, UpdateSourceTrigger=PropertyChanged, Delay=300}"
                                     Background="Transparent" BorderThickness="0"
                                     Foreground="{DynamicResource ForegroundPrimaryBrush}"
                                     FontSize="12" Padding="0,8"
                                     VerticalContentAlignment="Center"/>

                            <TextBlock Grid.Column="1" Text="Поиск товаров..." IsHitTestVisible="False"
                                       Foreground="{DynamicResource ForegroundTertiaryBrush}"
                                       FontSize="12" VerticalAlignment="Center"
                                       Visibility="{Binding Text.Length, ElementName=ItemSearchBox, Converter={StaticResource InverseBoolToVis}}"/>
                        </Grid>
                    </Border>
                </Grid>

                <!-- DataGrid -->
                <DataGrid Grid.Row="1" x:Name="ItemsDataGrid"
                          ItemsSource="{Binding Items}"
                          SelectedItem="{Binding SelectedItem}"
                          Style="{StaticResource ProductsDataGrid}"
                          ColumnHeaderStyle="{StaticResource ProductsDataGridColumnHeader}"
                          RowStyle="{StaticResource ProductsDataGridRow}"
                          CellStyle="{StaticResource ProductsDataGridCell}"
                          SelectionChanged="ItemsDataGrid_SelectionChanged"
                          MouseDoubleClick="ItemsDataGrid_MouseDoubleClick"
                          Margin="24,0,24,0">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="НАЗВАНИЕ" Binding="{Binding Name}" Width="*">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource DataGridTextStyle}">
                                    <Setter Property="Padding" Value="12,0"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="ЕД." Binding="{Binding UnitOfMeasure}" Width="60">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource DataGridTextCentered}"/>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="КОЛ-ВО" Binding="{Binding PurchaseCount}" Width="70">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource DataGridTextCentered}"/>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <DataGridTextColumn Header="МАГАЗИН" Binding="{Binding Shop}" Width="100">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock" BasedOn="{StaticResource DataGridTextSecondary}"/>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        <!-- Labels column -->
                        <DataGridTemplateColumn Header="МЕТКИ" Width="140">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ItemsControl ItemsSource="{Binding Labels}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border CornerRadius="4" Padding="8,2" Margin="0,0,4,0"
                                                        VerticalAlignment="Center">
                                                    <Border.Background>
                                                        <SolidColorBrush Color="{Binding Color}" Opacity="0.15"/>
                                                    </Border.Background>
                                                    <TextBlock Text="{Binding Name}" FontSize="10"
                                                               FontWeight="Medium"
                                                               VerticalAlignment="Center">
                                                        <TextBlock.Foreground>
                                                            <SolidColorBrush Color="{Binding Color}"/>
                                                        </TextBlock.Foreground>
                                                    </TextBlock>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                    <DataGrid.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Переместить в продукт" x:Name="MoveToProductMenuItem"/>
                            <MenuItem Header="Назначить метку" x:Name="AssignLabelMenuItem"/>
                            <Separator/>
                            <MenuItem Header="Снять все метки" Command="{Binding RemoveAllLabelsFromItemsCommand}"/>
                        </ContextMenu>
                    </DataGrid.ContextMenu>
                </DataGrid>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
