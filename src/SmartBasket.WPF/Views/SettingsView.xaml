<UserControl x:Class="SmartBasket.WPF.Views.SettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="400">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="6" MaxWidth="380" HorizontalAlignment="Left">

            <!-- Email (IMAP) Settings -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,6">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <Path Data="{StaticResource IconEmail}" Fill="#0078D4" Width="14" Height="14" Stretch="Uniform"/>
                        <TextBlock Text="Email (IMAP)" Style="{StaticResource H2}" Margin="6,0,0,0"/>
                    </StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="70"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Server" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding ImapServer, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Margin="0,0,0,3"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Port" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal" Margin="0,0,0,3">
                            <TextBox Text="{Binding ImapPort, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Width="50"/>
                            <CheckBox Content="SSL" IsChecked="{Binding UseSsl}" Foreground="{DynamicResource TextPrimaryBrush}" VerticalAlignment="Center" Margin="10,0,0,0" FontSize="11"/>
                        </StackPanel>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Username" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="2" Grid.Column="1" Text="{Binding EmailUsername, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Margin="0,0,0,3"/>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Password" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <PasswordBox Grid.Row="3" Grid.Column="1" x:Name="PasswordBox" Padding="4,2" Margin="0,0,0,3" FontSize="12"/>

                        <TextBlock Grid.Row="4" Grid.Column="0" Text="Sender" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="4" Grid.Column="1" Text="{Binding SenderFilter, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Margin="0,0,0,3"/>

                        <TextBlock Grid.Row="5" Grid.Column="0" Text="Subject" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="5" Grid.Column="1" Text="{Binding SubjectFilter, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Margin="0,0,0,3"/>

                        <TextBlock Grid.Row="6" Grid.Column="0" Text="Days back" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="6" Grid.Column="1" Text="{Binding SearchDaysBack, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Width="50" HorizontalAlignment="Left"/>
                    </Grid>
                    <Button Style="{StaticResource SecondaryButton}" Command="{Binding TestEmailConnectionCommand}"
                            IsEnabled="{Binding IsNotProcessing}" HorizontalAlignment="Left" Margin="0,6,0,0">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconPlug}" Fill="{DynamicResource TextPrimaryBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            <TextBlock Text="Test" Margin="4,0,0,0"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>

            <!-- LLM Provider Selection (per operation) -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,6">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <Path Data="{StaticResource IconSettings}" Fill="#881798" Width="14" Height="14" Stretch="Uniform"/>
                        <TextBlock Text="LLM Providers" Style="{StaticResource H2}" Margin="6,0,0,0"/>
                    </StackPanel>
                    <TextBlock Text="Выберите провайдер для каждой операции:" Style="{StaticResource TextSecondary}" Margin="0,0,0,6" FontSize="10"/>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="90"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Парсинг" Style="{StaticResource TextSecondary}" VerticalAlignment="Center" ToolTip="Извлечение товаров из текста чека"/>
                        <ComboBox Grid.Row="0" Grid.Column="1" SelectedIndex="{Binding ParsingProviderIndex}"
                                  FontSize="12" Padding="4,3" Margin="0,0,0,3">
                            <ComboBoxItem Content="Ollama"/>
                            <ComboBoxItem Content="YandexGPT"/>
                        </ComboBox>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Классификация" Style="{StaticResource TextSecondary}" VerticalAlignment="Center" ToolTip="Распределение товаров по категориям"/>
                        <ComboBox Grid.Row="1" Grid.Column="1" SelectedIndex="{Binding ClassificationProviderIndex}"
                                  FontSize="12" Padding="4,3" Margin="0,0,0,3">
                            <ComboBoxItem Content="Ollama"/>
                            <ComboBoxItem Content="YandexGPT"/>
                        </ComboBox>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Метки" Style="{StaticResource TextSecondary}" VerticalAlignment="Center" ToolTip="Назначение меток товарам"/>
                        <ComboBox Grid.Row="2" Grid.Column="1" SelectedIndex="{Binding LabelsProviderIndex}"
                                  FontSize="12" Padding="4,3">
                            <ComboBoxItem Content="Ollama"/>
                            <ComboBoxItem Content="YandexGPT"/>
                        </ComboBox>
                    </Grid>
                </StackPanel>
            </Border>

            <!-- Ollama Settings -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,6"
                    Visibility="{Binding IsOllamaUsed, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <Path Data="{StaticResource IconSettings}" Fill="#107C10" Width="14" Height="14" Stretch="Uniform"/>
                        <TextBlock Text="Ollama" Style="{StaticResource H2}" Margin="6,0,0,0"/>
                    </StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="50"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="URL" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding OllamaBaseUrl, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Margin="0,0,0,3"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Model" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Text="{Binding OllamaModel, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}"/>
                    </Grid>
                    <Button Style="{StaticResource SecondaryButton}" Command="{Binding TestOllamaConnectionCommand}"
                            IsEnabled="{Binding IsNotProcessing}" HorizontalAlignment="Left" Margin="0,6,0,0">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconPlug}" Fill="{DynamicResource TextPrimaryBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            <TextBlock Text="Test" Margin="4,0,0,0"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>

            <!-- YandexGPT Settings -->
            <Border Style="{StaticResource Card}" Margin="0,0,0,6"
                    Visibility="{Binding IsYandexGptUsed, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                        <Path Data="{StaticResource IconSettings}" Fill="#FF0000" Width="14" Height="14" Stretch="Uniform"/>
                        <TextBlock Text="YandexGPT" Style="{StaticResource H2}" Margin="6,0,0,0"/>
                    </StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="70"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Folder ID" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Text="{Binding YandexFolderId, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextInput}" Margin="0,0,0,3"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="API Key" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <PasswordBox Grid.Row="1" Grid.Column="1" x:Name="YandexApiKeyBox" Padding="4,2" Margin="0,0,0,3" FontSize="12"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Model" Style="{StaticResource TextSecondary}" VerticalAlignment="Center"/>
                        <ComboBox Grid.Row="2" Grid.Column="1" Text="{Binding YandexModel, UpdateSourceTrigger=PropertyChanged}"
                                  FontSize="12" Padding="4,3" IsEditable="True">
                            <ComboBoxItem Content="yandexgpt-lite"/>
                            <ComboBoxItem Content="yandexgpt"/>
                            <ComboBoxItem Content="yandexgpt-32k"/>
                            <ComboBoxItem Content="llama-lite"/>
                            <ComboBoxItem Content="llama"/>
                        </ComboBox>
                    </Grid>
                    <Button Style="{StaticResource SecondaryButton}" Command="{Binding TestYandexGptConnectionCommand}"
                            IsEnabled="{Binding IsNotProcessing}" HorizontalAlignment="Left" Margin="0,6,0,0">
                        <StackPanel Orientation="Horizontal">
                            <Path Data="{StaticResource IconPlug}" Fill="{DynamicResource TextPrimaryBrush}" Width="10" Height="10" Stretch="Uniform"/>
                            <TextBlock Text="Test" Margin="4,0,0,0"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Border>

            <!-- Save Button -->
            <Button Style="{StaticResource PrimaryButton}" Command="{Binding SaveSettingsCommand}" HorizontalAlignment="Left">
                <StackPanel Orientation="Horizontal">
                    <Path Data="{StaticResource IconSave}" Fill="White" Width="12" Height="12" Stretch="Uniform"/>
                    <TextBlock Text="Save" Margin="4,0,0,0"/>
                </StackPanel>
            </Button>
        </StackPanel>
    </ScrollViewer>
</UserControl>
