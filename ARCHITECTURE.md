# SmartBasket Architecture

---

## ğŸ”¥ğŸ”¥ğŸ”¥ Ğ—ĞĞ›ĞĞ¢ĞĞ• ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ: Ğ’ĞĞŸĞ ĞĞ¡ = ĞĞ‘Ğ¡Ğ£Ğ–Ğ”Ğ•ĞĞ˜Ğ•, ĞĞ• ĞšĞĞ” ğŸ”¥ğŸ”¥ğŸ”¥

**Ğ•ÑĞ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ·Ğ°ĞºĞ°Ğ½Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ Ğ·Ğ½Ğ°ĞºĞ¾Ğ¼ Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ° (`?`) â€” Ğ—ĞĞŸĞ Ğ•Ğ©Ğ•ĞĞ Ğ¼ĞµĞ½ÑÑ‚ÑŒ ĞºĞ¾Ğ´. ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ: Ğ¾Ğ±ÑÑƒĞ´Ğ¸Ñ‚ÑŒ, Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ, Ğ¾Ğ±ÑŠÑÑĞ½Ğ¸Ñ‚ÑŒ. Ğ­Ñ‚Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ‘Ğ•Ğ— Ğ˜Ğ¡ĞšĞ›Ğ®Ğ§Ğ•ĞĞ˜Ğ™.**

---

> **AI Integration:** Ğ¡Ğ¼. [ARCHITECTURE-AI.md](ARCHITECTURE-AI.md) Ğ´Ğ»Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ LLM Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°Ğ¼Ğ¸ Ğ¸ Tool Calling.

## Overview

SmartBasket â€” Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ÑĞ±Ğ¾Ñ€Ğ° Ğ¸ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‡ĞµĞºĞ¾Ğ² Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¾Ğ² Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ AI Ğ´Ğ»Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        SmartBasket.WPF                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ MainWindow  â”‚â”€â”€â”€â–¶â”‚ MainViewModel   â”‚â”€â”€â”€â–¶â”‚ Services (DI)  â”‚  â”‚
â”‚  â”‚   (XAML)    â”‚    â”‚ (Commands/Props)â”‚    â”‚                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SmartBasket     â”‚   â”‚ SmartBasket     â”‚   â”‚ SmartBasket     â”‚
â”‚   .Services     â”‚   â”‚   .Data         â”‚   â”‚   .Core         â”‚
â”‚                 â”‚   â”‚                 â”‚   â”‚                 â”‚
â”‚ â€¢ Sources       â”‚   â”‚ â€¢ DbContext     â”‚   â”‚ â€¢ Entities      â”‚
â”‚ â€¢ Parsers       â”‚   â”‚ â€¢ PostgreSQL    â”‚   â”‚ â€¢ Configuration â”‚
â”‚ â€¢ AI Providers  â”‚   â”‚                 â”‚   â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Domain Concepts

### Product (ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚)
**Ğ¡ÑƒÑ‚ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°** â€” Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ‚Ğ½Ğ°Ñ ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ.
- ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: "Ğ¡Ğ¾Ğº", "ĞœĞ¾Ğ»Ğ¾ĞºĞ¾", "Ğ¥Ğ»ĞµĞ±"
- Ğ˜ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· ParentId: "ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸" â†’ "Ğ¡Ğ¾ĞºĞ¸"
- AI Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚ Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ

### Item (Ğ¢Ğ¾Ğ²Ğ°Ñ€)
**ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ°Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ½Ğ°Ñ ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ğ°** â€” Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ğ½Ğ° Ğ¿Ğ¾Ğ»ĞºĞµ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°.
- ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹: "Ğ¡Ğ¾Ğº J7 Ğ°Ğ¿ĞµĞ»ÑŒÑĞ¸Ğ½Ğ¾Ğ²Ñ‹Ğ¹ 970 Ğ¼Ğ»"
- Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ĞµĞ½ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¼Ñƒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ· Ñ‡ĞµĞºĞ°
- Ğ¥Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸: UnitOfMeasure (Ğ¼Ğ», Ğ³), UnitQuantity (970)
- Ğ¡Ğ²ÑĞ·Ğ°Ğ½ Ñ Product (ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ĞµĞ¹)

### ReceiptItem (ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ² Ñ‡ĞµĞºĞµ)
**Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ¾ Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞµ** â€” ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾, Ñ†ĞµĞ½Ğ°, ÑÑƒĞ¼Ğ¼Ğ°.
- Ğ¡ÑÑ‹Ğ»Ğ°ĞµÑ‚ÑÑ Ğ½Ğ° Item
- Quantity Ğ² Ñ‡ĞµĞºĞµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒÑÑ Ğ¾Ñ‚ UnitQuantity Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°

---

## System Architecture

### Sources (Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸)

ĞšĞ°Ğ½Ğ°Ğ» Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑ‹Ñ€Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. ĞĞµ Ğ·Ğ½Ğ°ĞµÑ‚ Ğ¾ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğµ â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ.

```
ReceiptSource
â”œâ”€â”€ Name: string              // Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€
â”œâ”€â”€ Type: SourceType          // Email, REST, FileSystem
â”œâ”€â”€ Parser: string            // Ğ˜Ğ¼Ñ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ° Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
â””â”€â”€ IsEnabled: bool
```

| Type | Description |
|------|-------------|
| **Email** | IMAP Ğ¿Ğ¾Ñ‡Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ ÑÑ‰Ğ¸Ğº |
| **REST** | API ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½ĞµĞ³Ğ¾ ÑĞµÑ€Ğ²Ğ¸ÑĞ° |
| **FileSystem** | ĞŸĞ°Ğ¿ĞºĞ° Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸ |

---

### Parsers (ĞŸĞ°Ñ€ÑĞµÑ€Ñ‹)

Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµÑ‚ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· ÑÑ‹Ñ€Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ°.

```
IReceiptTextParser
â”œâ”€â”€ Name: string              // Ğ£Ğ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
â”œâ”€â”€ SupportedShops: string[]  // ĞœĞ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ñ‹ Ğ´Ğ»Ñ Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ³Ğ¾ Ğ°Ğ²Ñ‚Ğ¾-Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ñ ("*" = ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹)
â”œâ”€â”€ CanParse(text): bool      // ĞœĞ¾Ğ¶ĞµÑ‚ Ğ»Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑÑ‚ (Ğ´Ğ»Ñ auto-detect)
â””â”€â”€ Parse(text, date): ParsedReceipt
```

**Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€ÑĞµÑ€Ñ‹:**

| Parser | Name | SupportedShops | Description |
|--------|------|----------------|-------------|
| **InstamartParser** | `InstamartParser` | Instamart, Ğ¡Ğ±ĞµÑ€ĞœĞ°Ñ€ĞºĞµÑ‚, kuper.ru | Regex Ñ‡ĞµĞºĞ¾Ğ² Ğ¡Ğ±ĞµÑ€ĞœĞ°Ñ€ĞºĞµÑ‚ |
| **LlmUniversalParser** | `LlmUniversalParser` | * | Ğ£Ğ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ AI Ğ¿Ğ°Ñ€ÑĞµÑ€ |

**Ğ¤Ğ°Ğ±Ñ€Ğ¸ĞºĞ° Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ¾Ğ² (`ReceiptTextParserFactory`):**
- `GetParser(name)` â€” Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€ÑĞµÑ€ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
- `GetParserOrDefault(name)` â€” Ğ¿Ğ°Ñ€ÑĞµÑ€ Ğ¸Ğ»Ğ¸ LLM fallback
- `TryParseWithRegex(text, date)` â€” Ğ¿ĞµÑ€ĞµĞ±Ğ¾Ñ€ regex-Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ¾Ğ² Ğ¿Ğ¾ CanParse()

**Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ°:**
```
Source.Parser = "InstamartParser"  â†’ InstamartParser.Parse()
                                        â””â”€â”€ fail? â†’ LlmUniversalParser
Source.Parser = "Auto"             â†’ TryParseWithRegex() (Ğ¿Ğ¾ CanParse())
                                        â””â”€â”€ no match? â†’ LlmUniversalParser
```

---

### AI Providers (ĞŸĞ¾ÑÑ‚Ğ°Ğ²Ñ‰Ğ¸ĞºĞ¸ AI)

ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº AI-Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸. ĞšĞ»ÑÑ‡: `Provider/Model` Ğ¸Ğ»Ğ¸ `Provider/AgentId`.

```
AiProviderConfig
â”œâ”€â”€ Key: string               // "Ollama/qwen2.5:1.5b" Ğ¸Ğ»Ğ¸ "YandexAgent/fvtp..."
â”œâ”€â”€ Provider: ProviderType    // Ollama, YandexGPT, YandexAgent, OpenAI
â”œâ”€â”€ Model: string             // (Ğ½Ğµ Ğ´Ğ»Ñ YandexAgent)
â”œâ”€â”€ AgentId: string           // (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ YandexAgent)
â”œâ”€â”€ FolderId: string          // (Ğ´Ğ»Ñ Yandex*)
â””â”€â”€ Temperature, Timeout, ...
```

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸:**
| Provider | API | Streaming |
|----------|-----|-----------|
| `OllamaLlmProvider` | Ollama `/api/generate` | âœ“ NDJSON |
| `YandexGptLlmProvider` | Foundation Models API | âœ“ NDJSON |
| `YandexAgentLlmProvider` | REST Assistant API | âœ“ SSE |

**ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²:**
- `IResponseParser` â€” ÑƒĞ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğµ Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ JSON Ğ¸Ğ· LLM Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²
- ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°: markdown code blocks, chain-of-thought, bracket matching
- 5 fallback ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ½Ğ°Ğ´Ñ‘Ğ¶Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ°

---

### AI Operations (ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ AI)

Ğ¡Ğ²ÑĞ·ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ Ñ AI Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°Ğ¼Ğ¸.

```json
{
  "AiOperations": {
    "Classification": "Ollama/llama3.2:3b",
    "Labels": "YandexGPT/lite"
  }
}
```

| Operation | Description |
|-----------|-------------|
| **Classification** | Item â†’ Product |
| **Labels** | Item â†’ Labels |

---

### AI Prompts (Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ¾Ğ²)

ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹ Ğ´Ğ»Ñ AI Ğ¸Ğ¼ĞµÑÑ‚ **Ñ‚Ñ€Ğ¸ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚Ğ°**:

1. **ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚** (Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº UI) â€” Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹
2. **Ğ¤Ğ°Ğ¹Ğ» ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°** (`prompt_*.txt`) â€” ĞµÑĞ»Ğ¸ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½
3. **Hardcoded fallback** â€” ĞµÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½

**ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹:**
- Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· UI (Settings â†’ AI Operations â†’ "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚")
- Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑÑ‚ÑÑ Ğ² `AiOperations.Prompts` Ğ¿Ğ¾ ĞºĞ»ÑÑ‡Ñƒ `"Operation/ProviderKey"`
- ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ£Ğ¼Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚" â€” Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ GPT-4/Claude

| File | Service | Placeholders |
|------|---------|--------------|
| `prompt_template.txt` | LlmUniversalParser | `{{YEAR}}`, `{{RECEIPT_TEXT}}` |
| `prompt_classify_products.txt` | ProductClassificationService | `{{EXISTING_HIERARCHY}}`, `{{EXISTING_HIERARCHY_JSON}}`, `{{ITEMS}}` |
| `prompt_assign_labels.txt` | LabelAssignmentService | `{{LABELS}}`, `{{ITEMS}}` |

**Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ:** `SmartBasket.WPF/` (Ñ€ÑĞ´Ğ¾Ğ¼ Ñ exe)

**JSON-Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ğ¸** (`{{EXISTING_HIERARCHY_JSON}}`):
```json
[{"id": 1, "name": "ĞœĞ¾Ğ»Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ‚Ñ‹", "parent_id": null}, ...]
```
Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑƒĞ¼Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ `{{EXISTING_HIERARCHY}}`.

---

## Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    1. Ğ¡Ğ‘ĞĞ  Ğ¡Ğ«Ğ Ğ«Ğ¥ Ğ”ĞĞĞĞ«Ğ¥                         â”‚
â”‚  Source (Email/REST/FS) â†’ RawReceipt (text/html/json)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2. ĞŸĞĞ Ğ¡Ğ˜ĞĞ“                                   â”‚
â”‚  ReceiptTextParserFactory.GetParser(source.Parser)             â”‚
â”‚       â†’ Regex parser / LlmUniversalParser                      â”‚
â”‚       â†’ ParsedReceipt (Shop, Date, Items[])                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              3. ĞšĞĞ¢Ğ•Ğ“ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ (AI)                              â”‚
â”‚  ProductClassificationService: Item â†’ Product                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              4. ĞœĞ•Ğ¢ĞšĞ˜ (AI)                                      â”‚
â”‚  LabelAssignmentService: Item â†’ Labels                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              5. Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ•                                      â”‚
â”‚  Receipt + Items + ReceiptItems â†’ DB                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Labels      â”‚  â† ĞœĞµÑ‚ĞºĞ¸ ("ĞœĞ¾Ğ»Ğ¾ĞºĞ¾ Ğ´Ğ»Ñ ĞºĞ¾Ñ„Ğµ", "ĞŸĞ°Ğ¿Ğ° Ğ´Ğ¾Ğ²Ğ¾Ğ»ĞµĞ½")
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProductLabels  â”‚    â”‚   ItemLabels    â”‚  â† many-to-many
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Products     â”‚    â”‚     Items       â”‚
â”‚ (Ğ¸ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ)      â”‚â—„â”€â”€â”€â”‚ ProductId (FK)  â”‚  1 â”€â”€â”€â”€ *
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚ 1
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  ReceiptItems   â”‚  â† ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ² Ñ‡ĞµĞºĞµ
                       â”‚ Quantity, Price â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚    Receipts     â”‚  â† Ğ§ĞµĞº
                       â”‚ Shop, Date      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| Entity | Description |
|--------|-------------|
| **Product** | ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°. Ğ˜ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· ParentId. |
| **Item** | ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€. UnitOfMeasure, UnitQuantity. |
| **ReceiptItem** | ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ Ğ² Ñ‡ĞµĞºĞµ: Quantity, Price, Amount. |
| **Receipt** | Ğ§ĞµĞº: Shop, Date, Total, Status. |
| **Label** | ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ°Ñ Ğ¼ĞµÑ‚ĞºĞ°. |
| **EmailHistory** | Ğ”ĞµĞ´ÑƒĞ¿Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¸ÑĞµĞ¼. |

---

## Logging Architecture

Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾ Ğ½Ğ° **Serilog** Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ² UI Ñ‡ĞµÑ€ĞµĞ· custom sink.

```
ILogger<T>.LogXxx(...)
        â”‚
        â–¼
    Serilog
        â”œâ”€â†’ Debug Sink â”€â”€â”€â”€â”€â”€â”€â”€â†’ Visual Studio Output
        â”œâ”€â†’ File Sink â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ logs/smartbasket-YYYY-MM-DD.log
        â””â”€â†’ LogViewerSink â”€â”€â”€â”€â”€â†’ SmartBasket Logs UI (ObservableCollection)
```

### ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

| Component | Description |
|-----------|-------------|
| **LogViewerSink** | Custom Serilog sink â†’ `ObservableCollection<LogEntry>` Ğ´Ğ»Ñ UI |
| **LogEntry** | ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ»Ğ¾Ğ³Ğ°: Timestamp, Level, Message |
| **FilteredLogEntries** | `ICollectionView` Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ (Debug/Info/Warning/Error) |

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (App.xaml.cs)

```csharp
// ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº + Ñ€Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ > 24Ñ‡
var sessionTimestamp = DateTime.Now.ToString("yyyy-MM-dd_HH-mm-ss");
var logsPath = Path.Combine(logsDir, $"smartbasket_{sessionTimestamp}.log");

Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Debug()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
    .MinimumLevel.Override("System", LogEventLevel.Warning)
    .WriteTo.Debug(outputTemplate: "[{Timestamp:HH:mm:ss}] [{Level:u3}] {Message:lj}")
    .WriteTo.File(logsPath, rollingInterval: RollingInterval.Day, retainedFileCountLimit: 30)
    .WriteTo.LogViewer(LogEventLevel.Debug)
    .CreateLogger();
```

### Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

```csharp
// Ğ’ Ğ»ÑĞ±Ğ¾Ğ¼ ÑĞµÑ€Ğ²Ğ¸ÑĞµ Ñ‡ĞµÑ€ĞµĞ· DI
public class MyService
{
    private readonly ILogger<MyService> _logger;

    public MyService(ILogger<MyService> logger) => _logger = logger;

    public void DoWork()
    {
        _logger.LogDebug("Starting work...");
        _logger.LogInformation("Processed {Count} items", 42);
        _logger.LogError(ex, "Failed to process");
    }
}
```

### ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸

- **Thread-safe**: `LogViewerSink` Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ `BindingOperations.EnableCollectionSynchronization`
- **UI limit**: 10000 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ² UI (Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ), Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°
- **Per-session files**: ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº (`smartbasket_2025-12-16_14-30-45.log`)
- **Daily rotation**: Ğ Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ > 24Ñ‡, 30 Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
- **Structured logging**: ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ñ‡ĞµÑ€ĞµĞ· `{Placeholder}`, Ğ½Ğµ string interpolation
- **Full AI logging**: Ğ’ÑĞµ LLM Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹/Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ Debug

### ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ° UI Ğ»Ğ¾Ğ³Ğ°

```json
// appsettings.json
{
  "MaxUiLogEntries": 10000  // Default. Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ¸Ñ‚ÑŒ ĞµÑĞ»Ğ¸ UI Ñ‚Ğ¾Ñ€Ğ¼Ğ¾Ğ·Ğ¸Ñ‚
}
```

---

## Projects

### SmartBasket.Core
Entities Ğ¸ Configuration. Ğ‘ĞµĞ· Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹.

### SmartBasket.Data
EF Core DbContext. PostgreSQL / SQLite.

### SmartBasket.Services

**Sources:**
- `IReceiptSource`, `EmailReceiptSource`
- `IReceiptSourceFactory`

**Parsers:**
- `IReceiptTextParser`
- `InstamartReceiptParser` (regex)
- `LlmUniversalParser` (AI)
- `ReceiptTextParserFactory`

**AI/LLM:**
- `ILlmProvider`, `OllamaLlmProvider`, `YandexGptLlmProvider`, `YandexAgentLlmProvider`
- `IAiProviderFactory`
- `IResponseParser` â€” ÑƒĞ½Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³ JSON Ğ¸Ğ· LLM Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²

**Chat:**
- `IChatService`, `ChatService` â€” Ñ‡Ğ°Ñ‚ Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ Tool Calling
- Tool Loop: Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ² LLM
- ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° native tools Ğ¸ fallback (prompt injection)

**Tools:**
- `IToolExecutor`, `ToolExecutor` â€” Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
- `IToolHandler` â€” Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°
- **2 ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°** (Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ° ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ…):
  - `describe_data` â€” ÑÑ…ĞµĞ¼Ğ° Ğ‘Ğ” + Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ LLM ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
  - `query` â€” SqlKata-based ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ SELECT (JOIN, Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ñ‹, GROUP BY, HAVING)

**Services:**
- `ReceiptCollectionService` â€” Ğ¾Ñ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ±Ğ¾Ñ€Ğ°
- `ProductClassificationService` â€” ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- `LabelAssignmentService` â€” Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¼ĞµÑ‚Ğ¾Ğº
- `ProductCleanupService` â€” ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ÑĞ¸Ñ€Ğ¾Ñ‚ĞµĞ²ÑˆĞ¸Ñ… Products

### SmartBasket.WPF
MVVM Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ (CommunityToolkit.Mvvm).

**Logging:**
- `Logging/LogViewerSink.cs` â€” custom Serilog sink Ğ´Ğ»Ñ UI
- `Models/LogEntry.cs` â€” Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ»Ğ¾Ğ³Ğ° Ñ ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ¼

**Themes:**
- `ThemeManager.cs` â€” Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Light/Dark Ñ‚ĞµĞ¼

### SmartBasket.CLI
ĞšĞ¾Ğ½ÑĞ¾Ğ»ÑŒĞ½Ñ‹Ğµ ÑƒÑ‚Ğ¸Ğ»Ğ¸Ñ‚Ñ‹ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.
