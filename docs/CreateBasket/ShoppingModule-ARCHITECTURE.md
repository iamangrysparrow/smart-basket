# Shopping Module â€” ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

> ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ĞµĞ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ°ĞºÑƒĞ¿Ğ¾Ğº
> Ğ’ĞµÑ€ÑĞ¸Ñ: 3.0
> Ğ”Ğ°Ñ‚Ğ°: Ğ”ĞµĞºĞ°Ğ±Ñ€ÑŒ 2024
> ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: 28.12.2024

---

## 1. ĞĞ±Ğ·Ğ¾Ñ€

### Ğ¦ĞµĞ»ÑŒ

ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ·Ğ°ĞºÑƒĞ¿Ğ¾Ğº: Ğ¾Ñ‚ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ‡ĞµĞºĞ¾Ğ² Ğ´Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹ Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ.

### Ğ¢Ñ€Ğ¸ ÑÑ‚Ğ°Ğ¿Ğ° workflow

| # | Ğ­Ñ‚Ğ°Ğ¿ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | AI Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ |
|---|------|----------|-------------|--------|
| 1 | Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹ | Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ñ AI, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ/ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² | ShoppingChat | âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ |
| 2 | ĞŸĞ¾Ğ¸ÑĞº Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°Ñ… | ĞŸĞ¾Ğ¸ÑĞº ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸ Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğµ | â€” | âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ |
| 3 | Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² | AI Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ñ Ğ¾Ğ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¸ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°Ğ¼Ğ¸ | ProductMatcher | âœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾ |

---

## 2. AI ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸

Ğ¢Ñ€Ğ¸ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ğµ AI Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸, ĞºĞ°Ğ¶Ğ´Ğ°Ñ ÑĞ¾ ÑĞ²Ğ¾Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ¾Ğ¼:

```
ShoppingChat       â†’ Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³, ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹ (Smart: YandexAgent)
ProductMatcher     â†’ Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°, Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñ‹, Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° (YandexAgent Ñ variables Ğ˜Ğ›Ğ˜ Ollama Ñ tool calling)
BasketReview       â†’ Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ğ·Ğ¾Ñ€, Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸, Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²ĞºĞ° (TBD)
```

### ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿ Ğ¸Ğ½ĞºĞ°Ğ¿ÑÑƒĞ»ÑÑ†Ğ¸Ğ¸

- **ViewModel Ğ¸ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ ĞĞ• Ğ·Ğ½Ğ°ÑÑ‚ Ğ¿Ñ€Ğ¾ AI** â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ, Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ÑÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
- **Ğ’ÑÑ Ğ¼ĞµÑ…Ğ°Ğ½Ğ¸ĞºĞ° AI ÑĞºÑ€Ñ‹Ñ‚Ğ°** Ğ² Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹, Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³, tools)
- **ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ = ĞºĞ»Ğ°ÑÑ**, Ñ€ĞµĞ°Ğ»Ğ¸Ğ·ÑƒÑÑ‰Ğ¸Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
- **ĞŸÑ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚ÑÑ** Ñ‡ĞµÑ€ĞµĞ· ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ÑƒÑ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ AiOperations

### Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹

```csharp
// Ğ­Ñ‚Ğ°Ğ¿ 1: Ğ§Ğ°Ñ‚
IShoppingChatOperation.ProcessMessageAsync(message, session)
    â†’ IAsyncEnumerable<WorkflowProgress>

// Ğ­Ñ‚Ğ°Ğ¿ 2+3: ĞŸĞ¾Ğ¸ÑĞº Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€ (Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¾ Ğ² BasketBuilder)
IBasketBuilderOperation.BuildBasketAsync(session, stores)
    â†’ IAsyncEnumerable<WorkflowProgress>

// Ğ­Ñ‚Ğ°Ğ¿ 3: Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° (Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ğ¹, Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· BasketBuilder)
IProductMatcherOperation.SelectProductAsync(draftItem, candidates, history)
    â†’ ProductSelectionResult

// Ğ­Ñ‚Ğ°Ğ¿ 4: ĞĞ±Ğ·Ğ¾Ñ€ (TBD)
IBasketReviewOperation.ReviewAsync(basket)
    â†’ BasketReviewResult
```

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (appsettings.json)

```json
{
  "AiOperations": {
    "ShoppingChat": "YandexAgent/agent-id-for-chat",
    "ProductMatcher": "YandexAgent/agent-id-for-matcher",
    "Shopping": "YandexAgent/fallback-agent"
  }
}
```

### ProductMatcher â€” Ğ”Ğ²Ğ° Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ° Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹

`ProductMatcherOperation` Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ±Ğ¸Ñ€Ğ°ĞµÑ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°:

#### 1. YandexAgent (prompt.variables) â€” Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµĞ¼Ñ‹Ğ¹

- ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ Ğ² Ğ°Ğ³ĞµĞ½Ñ‚Ğµ Yandex AI Studio
- ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°ÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· `prompt.variables`
- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (ÑĞºĞ¾Ğ½Ğ¾Ğ¼Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²)
- ĞÑ‚Ğ²ĞµÑ‚ â€” plain JSON Ğ² `output_text`

```csharp
// ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
{
  "DRAFT_ITEM_NAME": "ĞœĞ¾Ğ»Ğ¾ĞºĞ¾",
  "DRAFT_ITEM_QUANTITY": "2",
  "DRAFT_ITEM_UNIT": "Ğ»",
  "SEARCH_RESULTS": "Id | Name | Price | Unit | Qty | InStock\n..."
}

// Input
"Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ñ"

// Response (plain JSON)
{
  "selected_product_id": "moloko-dom-25",
  "quantity": 3,
  "reasoning": "...",
  "alternatives": ["id1", "id2"]
}
```

**Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚Ğ°:** `docs/CreateBasket/ProductMatcher-YandexAgent-PROMPT.md`

#### 2. Tool Calling (Ollama, etc.)

- ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ÑÑ Ğ¸Ğ· `prompt_shopping_select_product.txt`
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ tool calling API
- JSON Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

```csharp
// Tool: select_product
{
  "selected_product_id": "...",
  "quantity": 1,
  "reasoning": "...",
  "alternatives": [{"product_id": "..."}]
}
```

---

## 3. Workflow Timeline

### ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Ñ‡Ğ°Ñ‚Ğ° â€” **ĞµĞ´Ğ¸Ğ½Ğ°Ñ Ğ»ĞµĞ½Ñ‚Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹**, Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‰Ğ°Ñ Ğ²ĞµÑÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ ÑĞ±Ğ¾Ñ€ĞºĞ¸ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹.

### Ğ˜ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

```csharp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ‘ĞĞ—ĞĞ’Ğ«Ğ™ Ğ¢Ğ˜ĞŸ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
public abstract record WorkflowProgress(DateTime Timestamp);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ­Ğ¢ĞĞŸ 1: Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
public record TextDeltaProgress(string Text) 
    : WorkflowProgress(DateTime.Now);

public record ToolCallProgress(string Name, string Args) 
    : WorkflowProgress(DateTime.Now);

public record ToolResultProgress(string Name, string Result, bool Success) 
    : WorkflowProgress(DateTime.Now);

public record ChatCompleteProgress() 
    : WorkflowProgress(DateTime.Now);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ­Ğ¢ĞĞŸ 2: ĞŸĞ¾Ğ¸ÑĞº Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°Ñ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
public record SearchStartedProgress(string ProductName, string StoreName) 
    : WorkflowProgress(DateTime.Now);

public record SearchCompletedProgress(string ProductName, string StoreName, int ResultCount) 
    : WorkflowProgress(DateTime.Now);

public record SearchFailedProgress(string ProductName, string StoreName, string Error) 
    : WorkflowProgress(DateTime.Now);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ­Ğ¢ĞĞŸ 3: Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
public record ProductSelectionStartedProgress(string DraftItemName, string StoreName) 
    : WorkflowProgress(DateTime.Now);

public record ProductSelectionCompletedProgress(
    string DraftItemName,
    string StoreName,
    ProductSearchResult Selected,
    string Reason,
    List<ProductSearchResult> Alternatives   // Ğ˜Ğ· Ğ­Ğ¢ĞĞ“Ğ Ğ–Ğ• Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°
) : WorkflowProgress(DateTime.Now);
```

### ĞœĞ¾Ğ´ĞµĞ»ÑŒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° (ĞµĞ´Ğ¸Ğ½Ğ°Ñ)

Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ¸Ğ· Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ¾Ğ²:

```csharp
public record ProductSearchResult(
    string Id,              // ID Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° (slug Ğ¸Ğ· URL)
    string Name,            // ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
    decimal Price,          // Ğ¦ĞµĞ½Ğ°
    string? Unit,           // "Ğ³", "ĞºĞ³", "ÑˆÑ‚", "Ğ»", "Ğ¼Ğ»"
    decimal Quantity,       // ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ² ĞµĞ´Ğ¸Ğ½Ğ¸Ñ†Ğµ Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ
    bool InStock,           // Ğ’ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğ¸
    string? ImageUrl,       // URL Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
    string ProductUrl       // ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ URL ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
);
```

---

## 4. UI

### Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

1. **ĞĞ´Ğ¸Ğ½ DataTemplate Ğ½Ğ° Ñ‚Ğ¸Ğ¿ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ** â€” Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ¸Ğ¼Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸
2. **ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ°** â€” ĞµÑĞ»Ğ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ² Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞµ (IsCompleted=false), Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸Ğ½Ğ½ĞµÑ€
3. **ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ** â€” Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ (tool calls, search) ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ
4. **ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°** â€” ProductSelection Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ ĞºĞ°Ğº Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ğ½ÑƒÑ‚Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ°

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ProductSelection Ğ² UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ“ ĞœĞ¾Ğ»Ğ¾ĞºĞ¾ 1.5%                               Samokat         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [ğŸ¥›]  ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ĞºĞ²Ğ°ÑˆĞ¸Ğ½Ğ¾ 1Ğ»                         89.90 â‚½  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ğ»Ğ¸ 3 Ñ€Ğ°Ğ·Ğ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†, Ğ»ÑƒÑ‡ÑˆĞ°Ñ Ñ†ĞµĞ½Ğ° ÑÑ€ĞµĞ´Ğ¸ Ğ·Ğ½Ğ°ĞºĞ¾Ğ¼Ñ‹Ñ… Ğ¼Ğ°Ñ€Ğ¾Ğº â”‚
â”‚                                                             â”‚
â”‚ â–¶ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñ‹                                              â”‚
â”‚   â”œâ”€ Ğ”Ğ¾Ğ¼Ğ¸Ğº Ğ² Ğ´ĞµÑ€ĞµĞ²Ğ½Ğµ 1Ğ»      95.90 â‚½                       â”‚
â”‚   â””â”€ Parmalat 1Ğ»            109.00 â‚½                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Handler Ñ pattern matching

```csharp
var progress = new DispatcherProgress<WorkflowProgress>(dispatcher, p =>
{
    switch (p)
    {
        case TextDeltaProgress delta:
            AppendText(delta.Text);
            break;
            
        case ToolCallProgress tool:
            AddToolCallEvent(tool.Name, tool.Args);
            break;
            
        case SearchStartedProgress search:
            AddSearchEvent(search.ProductName, search.StoreName, isCompleted: false);
            break;
            
        case SearchCompletedProgress search:
            CompleteSearchEvent(search.ProductName, search.StoreName, search.ResultCount);
            break;
            
        case ProductSelectionStartedProgress sel:
            AddSelectionEvent(sel.DraftItemName, sel.StoreName, isCompleted: false);
            break;
            
        case ProductSelectionCompletedProgress sel:
            CompleteSelectionEvent(sel);
            break;
    }
});
```

---

## 5. Ğ¤Ğ°Ğ¹Ğ»Ñ‹

### Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ

```
src/SmartBasket.Services/Shopping/
â”œâ”€â”€ Operations/
â”‚   â”œâ”€â”€ IShoppingChatOperation.cs      âœ… Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ñ‡Ğ°Ñ‚Ğ°
â”‚   â”œâ”€â”€ ShoppingChatOperation.cs       âœ… Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (tool calling)
â”‚   â”œâ”€â”€ IProductMatcherOperation.cs    âœ… Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
â”‚   â”œâ”€â”€ ProductMatcherOperation.cs     âœ… Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (YandexAgent + Ollama)
â”‚   â”œâ”€â”€ IBasketBuilderOperation.cs     âœ… Ğ˜Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ ÑĞ±Ğ¾Ñ€ĞºĞ¸ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹
â”‚   â””â”€â”€ BasketBuilderOperation.cs      âœ… Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (Ğ¿Ğ¾Ğ¸ÑĞº + Ğ²Ñ‹Ğ±Ğ¾Ñ€)
â”œâ”€â”€ WorkflowProgress.cs                âœ… Ğ˜ĞµÑ€Ğ°Ñ€Ñ…Ğ¸Ñ Ñ‚Ğ¸Ğ¿Ğ¾Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
â””â”€â”€ (ProductSelectionResult Ğ² IProductMatcherOperation.cs)

src/SmartBasket.WPF/Views/Shopping/
â”œâ”€â”€ WorkflowEventTemplates.xaml        âœ… DataTemplates Ğ´Ğ»Ñ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
â”œâ”€â”€ WorkflowEvent.cs                   âœ… ViewModel-Ğ¾Ğ±Ñ‘Ñ€Ñ‚ĞºĞ° Ğ´Ğ»Ñ UI
â”œâ”€â”€ ShoppingView.xaml                  âœ… ĞĞ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½
â””â”€â”€ ShoppingViewModel.cs               âœ… Pattern matching handler

src/SmartBasket.Core/Helpers/
â””â”€â”€ Json.cs                            âœ… Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ JSON (ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ°!)

src/SmartBasket.Services/Llm/
â”œâ”€â”€ YandexAgentLlmProvider.cs          âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ GenerateWithVariablesAsync()
â””â”€â”€ LlmJsonOptions.cs                  âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Json.DefaultOptions
```

### Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ

```
docs/CreateBasket/
â”œâ”€â”€ ShoppingModule-ARCHITECTURE.md     â† Ğ­Ñ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ»
â”œâ”€â”€ ProductMatcher-YandexAgent-PROMPT.md  âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ Ğ°Ğ³ĞµĞ½Ñ‚Ğ° Ğ² Yandex AI Studio
â”œâ”€â”€ WeeklyShoppingModule-SPEC.md       Ğ¡Ğ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ
â””â”€â”€ WeeklyShoppingModule-IMPLEMENTATION.md  ĞŸĞ»Ğ°Ğ½ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
```

### ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹

```
src/SmartBasket.WPF/
â”œâ”€â”€ prompt_shopping_select_product.txt  âœ… ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ´Ğ»Ñ ProductMatcher (tool calling)
â”œâ”€â”€ prompt_chat_priming.txt             ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ‘Ğ” Ğ´Ğ»Ñ Ñ‡Ğ°Ñ‚Ğ°
â”œâ”€â”€ prompt_chat_tools.txt               Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ tool calling
â””â”€â”€ ...
```

---

## 6. Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸

### JSON ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ°)

**Ğ’ĞĞ–ĞĞ:** Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `SmartBasket.Core.Helpers.Json` Ğ²Ğ¼ĞµÑÑ‚Ğ¾ `JsonSerializer`:

```csharp
// âŒ ĞĞ• Ğ”Ğ•Ğ›ĞĞ¢Ğ¬ â€” ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ° ĞºĞ°Ğº \uXXXX
JsonSerializer.Serialize(obj)

// âœ… ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ â€” Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ°Ñ ĞºĞ¸Ñ€Ğ¸Ğ»Ğ»Ğ¸Ñ†Ğ°
Json.Serialize(obj)        // ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹
Json.SerializePretty(obj)  // Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²
Json.Deserialize<T>(json)  // Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³
```

### ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ğ¾Ğ¸ÑĞºĞ°

```csharp
// ShoppingSettings.cs
public int SearchLimit { get; set; } = 8;  // Ğ‘Ñ‹Ğ»Ğ¾ 3, ÑƒĞ²ĞµĞ»Ğ¸Ñ‡ĞµĞ½Ğ¾
```

---

## 7. ĞĞµ Ğ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒ

- Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° `ShoppingSessionService` Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ
- ĞŸÑ€Ğ°Ğ²Ğ°Ñ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ¾Ğº Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ
- WebView2 Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ¾Ğ² Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ
- Ğ¡ÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° `IAiProviderFactory` Ğ¸ `AiOperations` Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ
- `ProductSearchResult` Ğ¸Ğ· Ğ¿Ğ°Ñ€ÑĞµÑ€Ğ¾Ğ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ ĞºĞ°Ğº ĞµÑÑ‚ÑŒ

---

## 8. TODO / Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

### Ğ‘Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğµ

- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°Ğ³ĞµĞ½Ñ‚ ProductMatcher Ğ² Yandex AI Studio (Ğ¿Ñ€Ğ¾Ğ¼Ğ¿Ñ‚ Ğ² `ProductMatcher-YandexAgent-PROMPT.md`)
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€ ProductMatcher Ğ² UI Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
- [ ] ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ñ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ğ¼Ğ¸

### Ğ‘ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ

- [ ] BasketReviewOperation â€” Ñ„Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ğ·Ğ¾Ñ€ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñ‹
- [ ] Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ² PlannedBasket
- [ ] UI Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°/Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²
- [ ] Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Ğ·Ğ°ĞºĞ°Ğ·Ğ° Ğ² Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ°Ñ…
