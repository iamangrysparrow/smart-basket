# TODO 2025-12-12

## Выполнено сегодня

### 1. UI для настройки AI Prompts — ВЫПОЛНЕНО

**Задача**: Добавить возможность редактирования промптов через UI настроек.

**Реализовано**:
- [x] `PromptEditorWindow.xaml/.cs` — модальное окно редактирования промптов
- [x] Кастомный промпт для каждой операции + провайдера
- [x] Кнопка "Умный промпт" — вставка минимального промпта для GPT-4/Claude
- [x] Кнопка "Сбросить к дефолту" — возврат к стандартному промпту
- [x] Индикаторы "(настроен)" в AiOperationsSettingsView для операций с кастомными промптами
- [x] Хранение в `AiOperationsConfig.Prompts` по ключу `"Operation/ProviderKey"`
- [x] Приоритет: Кастомный → Файл шаблона → Hardcoded fallback
- [x] `SetCustomPrompt()` метод в `IProductClassificationService`, `ILabelAssignmentService`
- [x] `SetupCustomPrompts()` в `ReceiptCollectionService` — применяет кастомные промпты при запуске

**Файлы изменены**:
- `SmartBasket.WPF/Views/PromptEditorWindow.xaml` — UI редактора
- `SmartBasket.WPF/Views/PromptEditorWindow.xaml.cs` — логика редактора
- `SmartBasket.WPF/Views/Settings/AiOperationsSettingsView.xaml` — ссылки на редактор
- `SmartBasket.WPF/Views/Settings/AiOperationsSettingsView.xaml.cs` — обработчики
- `SmartBasket.Core/Configuration/AiOperationsConfig.cs` — хранение промптов
- `SmartBasket.Services/Llm/ProductClassificationService.cs` — SetCustomPrompt
- `SmartBasket.Services/Llm/LabelAssignmentService.cs` — SetCustomPrompt
- `SmartBasket.Services/ReceiptCollectionService.cs` — SetupCustomPrompts

---

### 2. Поддержка JSON-формата иерархии для умных моделей — ВЫПОЛНЕНО

**Задача**: Добавить альтернативный формат иерархии продуктов для умных моделей.

**Реализовано**:
- [x] `BuildHierarchyJson()` в `ProductClassificationService` — JSON-представление иерархии
- [x] Placeholder `{{EXISTING_HIERARCHY_JSON}}` — альтернатива текстовому `{{EXISTING_HIERARCHY}}`
- [x] Опциональное поле `path` в `ClassifiedItem` — путь в иерархии как массив
- [x] "Умный промпт" использует JSON-формат и запрашивает path в ответе

**JSON-формат иерархии**:
```json
[{"id": 1, "name": "Молочные продукты", "parent_id": null}, ...]
```

**Формат ответа с path**:
```json
{
  "products": [{"name": "Йогурт", "parent": "Молочные продукты"}],
  "items": [{"name": "Молоко 2.5%", "product": "Молоко", "path": ["Молочные продукты", "Молоко"]}]
}
```

---

### 3. Исправлена проблема "Не категоризировано" — ВЫПОЛНЕНО

**Проблема**: Модель создавала категорию "Не категоризировано" для товаров, которые не знала куда отнести.

**Решение**:
- [x] Добавлено правило №6 в `prompt_classify_products.txt`
- [x] Обновлён hardcoded промпт в `PromptEditorWindow.xaml.cs`
- [x] Обновлён "Умный промпт" с явным запретом

**Правило**: ЗАПРЕЩЕНО использовать "Не категоризировано", "Другое", "Прочее" — всегда создавай конкретную категорию

---

## Что осталось

### UI улучшения
- [ ] Preview промпта с подстановкой тестовых данных
- [ ] Валидация плейсхолдеров в редакторе промптов
- [ ] UI для управления метками (Labels)

### Аналитика
- [ ] Аналитика по меткам и категориям
- [ ] Графики расходов по времени

### Источники данных
- [ ] REST источник чеков
- [ ] FileSystem источник чеков

### Оптимизация
- [ ] Кэширование ответов LLM для повторных запросов
- [ ] Batch-парсинг нескольких чеков за один запрос
